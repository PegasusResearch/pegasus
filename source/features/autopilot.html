<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Autopilot &mdash; Pegasus  documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
        <script type="module" src="https://cdn.jsdelivr.net/npm/mermaid@11.2.0/dist/mermaid.esm.min.mjs"></script>
        <script type="module" src="https://cdn.jsdelivr.net/npm/@mermaid-js/layout-elk@0.1.4/dist/mermaid-layout-elk.esm.min.mjs"></script>
        <script type="module">import mermaid from "https://cdn.jsdelivr.net/npm/mermaid@11.2.0/dist/mermaid.esm.min.mjs";import elkLayouts from "https://cdn.jsdelivr.net/npm/@mermaid-js/layout-elk@0.1.4/dist/mermaid-layout-elk.esm.min.mjs";mermaid.registerLayoutLoaders(elkLayouts);mermaid.initialize({startOnLoad:false});</script>
        <script src="https://cdn.jsdelivr.net/npm/d3@7.9.0/dist/d3.min.js"></script>
        <script type="module">
import mermaid from "https://cdn.jsdelivr.net/npm/mermaid@11.2.0/dist/mermaid.esm.min.mjs";
window.addEventListener("load", () => mermaid.run());
</script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Modes" href="modes.html" />
    <link rel="prev" title="Standards" href="../setup/reference_frames.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #000000" >

          
          
          <a href="../../index.html">
            
              <img src="../../_static/logo.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../setup/installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../setup/reference_frames.html">Standards</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Features</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Autopilot</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#operating-modes">0. Operating Modes</a></li>
<li class="toctree-l2"><a class="reference internal" href="#autopilot-interface">1. Autopilot Interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="#explanation">2. Explanation</a></li>
<li class="toctree-l2"><a class="reference internal" href="#autopilot-configuration-file">3. Autopilot Configuration File</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="modes.html">Modes</a></li>
<li class="toctree-l1"><a class="reference internal" href="controllers.html">Controllers</a></li>
<li class="toctree-l1"><a class="reference internal" href="geofencing.html">Geofencing</a></li>
<li class="toctree-l1"><a class="reference internal" href="trajectory_manager.html">Trajectory Manager</a></li>
<li class="toctree-l1"><a class="reference internal" href="../console/terminal_console.html">Terminal console</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Simulation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../simulation/gazebo_classic.html">Gazebo Classic</a></li>
<li class="toctree-l1"><a class="reference internal" href="../simulation/pegasus_simulator.html">Pegasus Simulator</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Vehicles</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../vehicles/pegasus.html">Pegasus Drone v1.0.0</a></li>
<li class="toctree-l1"><a class="reference internal" href="../vehicles/kopis.html">Kopis Drone Setup</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Flight Arena</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../arena/arena.html">Taguspark Flight Arena</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">References</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../references/license.html">License</a></li>
<li class="toctree-l1"><a class="reference internal" href="../references/bibliography.html">Bibliography</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #000000" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Pegasus</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Autopilot</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/source/features/autopilot.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="autopilot">
<h1>Autopilot<a class="headerlink" href="#autopilot" title="Permalink to this heading"></a></h1>
<p>At the center of the Guidance and Control system is the Autopilot, implemented in C++. This is located inside the <code class="docutils literal notranslate"><span class="pre">pegasus_autopilot/autopilot</span></code> package.
The Autopilot is responsible for keeping track of the current operating <code class="docutils literal notranslate"><span class="pre">mode</span></code> of the vehicle. It exposes to each operation <code class="docutils literal notranslate"><span class="pre">mode</span></code> the following APIs:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">Control</span></code> - Provides the control commands to the vehicle to track a given position, attitude, velocity, etc.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Geofencing</span></code> - Checks if the vehicle is within the geofence and if not, provides the control commands to bring the vehicle back inside the geofence.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Trajectory</span> <span class="pre">Manager</span></code> - Manages desired trajectories for the vehicle to follow.</p></li>
</ul>
<p>It also provides each mode with the current <code class="docutils literal notranslate"><span class="pre">state</span></code> of the vehicle, which includes the current position, velocity, attitude, etc.</p>
<a class="reference internal image-reference" href="../../_images/autopilot_architecture.png"><img alt="Autopilot Architecture" class="align-center" src="../../_images/autopilot_architecture.png" style="width: 400px;" /></a>
<p>The autopilot operation <code class="docutils literal notranslate"><span class="pre">modes</span></code>, <code class="docutils literal notranslate"><span class="pre">controllers</span></code>, <code class="docutils literal notranslate"><span class="pre">geofencing</span></code> and <code class="docutils literal notranslate"><span class="pre">trajectory</span> <span class="pre">manager</span></code> are implemented as ROS 2 plugins. This allows for easy extensibility and customization of the Autopilot, without having
to modify the base autopilot packages. The Autopilot is responsible for loading the plugins at runtime and managing the communication between them.</p>
<pre  class="mermaid">
        classDiagram
   pegasus &lt;|-- pegasus_interfaces
   pegasus &lt;|-- pegasus_console
   pegasus &lt;|-- pegasus_autopilot
   pegasus &lt;|-- pegasus_api
   pegasus_autopilot &lt;|-- autopilot_modes
   pegasus_autopilot &lt;|-- autopilot_controllers
   pegasus_autopilot &lt;|-- geofencing
   pegasus_autopilot &lt;|-- trajectory_manager
   trajectory_manager &lt;|-- static_trajectory_manager
   static_trajectory_manager &lt;|-- static_trajectories
   geofencing &lt;|-- box_geofencing
   pegasus_interfaces &lt;|-- mocap_interface
   pegasus_interfaces &lt;|-- mavlink_interface
   class pegasus{
      &lt;&lt;Meta Package&gt;&gt;
      VehicleLaunchFiles
      VehicleConfigurationFiles
   }
   class mocap_interface{
      &lt;&lt;C++ Package&gt;&gt;
   }
   class pegasus_interfaces{
      &lt;&lt;Meta Package&gt;&gt;
   }
   class mavlink_interface{
      &lt;&lt;C++ Package&gt;&gt;
   }
   class pegasus_console{
      &lt;&lt;C++ Package&gt;&gt;
   }
   class pegasus_autopilot{
      &lt;&lt;C++ Package&gt;&gt;
   }
   class autopilot_controllers{
      &lt;&lt;C++ Package&gt;&gt;
   }
   class autopilot_modes{
      &lt;&lt;C++ Package&gt;&gt;
   }
   class pegasus_api{
      &lt;&lt;Python Package&gt;&gt;
   }
   class trajectory_manager{
      &lt;&lt;C++ Package&gt;&gt;
   }
    </pre><section id="operating-modes">
<h2>0. Operating Modes<a class="headerlink" href="#operating-modes" title="Permalink to this heading"></a></h2>
<p>The default operating modes provided by the Autopilot are:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">Arm</span></code> - The vehicle is armed and ready to take off.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Disarm</span></code> - The vehicle is on the ground and disarmed.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Takeoff</span></code> - The vehicle takes of to a predefined altitude above the current position.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Land</span></code> - The vehicle lands at the current position.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Hold</span></code> - The vehicle holds its current position.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Follow</span> <span class="pre">Trajectory</span></code> - The vehicle follows the trajectory loaded in the trajectory manager.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Waypoint</span></code> - The vehicle goes to a waypoint.</p></li>
</ul>
</section>
<section id="autopilot-interface">
<h2>1. Autopilot Interface<a class="headerlink" href="#autopilot-interface" title="Permalink to this heading"></a></h2>
<p>The Autopilot is defined in the under the <code class="docutils literal notranslate"><span class="pre">pegasus_autopilot/autopilot/include/autopilot/autopilot.hpp</span></code> header file.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos">  1</span><span class="k">namespace</span><span class="w"> </span><span class="nn">autopilot</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">  2</span>
<span class="linenos">  3</span><span class="k">class</span><span class="w"> </span><span class="nc">Autopilot</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">Node</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">  4</span>
<span class="linenos">  5</span><span class="k">public</span><span class="o">:</span>
<span class="linenos">  6</span>
<span class="linenos">  7</span><span class="w">    </span><span class="n">Autopilot</span><span class="p">();</span>
<span class="linenos">  8</span><span class="w">    </span><span class="o">~</span><span class="n">Autopilot</span><span class="p">()</span><span class="w"> </span><span class="p">{}</span>
<span class="linenos">  9</span>
<span class="linenos"> 10</span><span class="w">    </span><span class="c1">// Function that executes periodically the control loop of each operation mode</span>
<span class="linenos"> 11</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">update</span><span class="p">();</span>
<span class="linenos"> 12</span><span class="w">    </span>
<span class="linenos"> 13</span><span class="w">    </span><span class="c1">// Function that establishes the state machine to transition between operating modes</span>
<span class="linenos"> 14</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="nf">change_mode</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">new_mode</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">force</span><span class="o">=</span><span class="nb">false</span><span class="p">);</span>
<span class="linenos"> 15</span>
<span class="linenos"> 16</span><span class="w">    </span><span class="c1">// Function that signals that the current mode has finished its operation and should transition to the fallback mode</span>
<span class="linenos"> 17</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">signal_mode_finished</span><span class="p">();</span>
<span class="linenos"> 18</span>
<span class="linenos"> 19</span><span class="w">    </span><span class="c1">// Returns the current mode of operation of the autopilot and state of the vehicle</span>
<span class="linenos"> 20</span><span class="w">    </span><span class="kr">inline</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="nf">get_mode</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">current_mode_</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="linenos"> 21</span><span class="w">    </span><span class="kr">inline</span><span class="w"> </span><span class="n">State</span><span class="w"> </span><span class="nf">get_state</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">state_</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="linenos"> 22</span><span class="w">    </span><span class="kr">inline</span><span class="w"> </span><span class="n">VehicleStatus</span><span class="w"> </span><span class="nf">get_status</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">status_</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="linenos"> 23</span><span class="w">    </span><span class="kr">inline</span><span class="w"> </span><span class="n">VehicleConstants</span><span class="w"> </span><span class="nf">get_vehicle_constants</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">vehicle_constants_</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="linenos"> 24</span>
<span class="linenos"> 25</span><span class="w">    </span><span class="c1">// Initializes the autopilot to run</span>
<span class="linenos"> 26</span><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">initialize</span><span class="p">();</span>
<span class="linenos"> 27</span>
<span class="linenos"> 28</span><span class="k">private</span><span class="o">:</span>
<span class="linenos"> 29</span>
<span class="linenos"> 30</span><span class="w">    </span><span class="c1">// Pre-initializations of the autopilot</span>
<span class="linenos"> 31</span><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">initialize_controller</span><span class="p">();</span>
<span class="linenos"> 32</span><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">initialize_geofencing</span><span class="p">();</span>
<span class="linenos"> 33</span><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">initialize_trajectory_manager</span><span class="p">();</span>
<span class="linenos"> 34</span><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">initialize_operating_modes</span><span class="p">();</span>
<span class="linenos"> 35</span>
<span class="linenos"> 36</span><span class="w">    </span><span class="c1">// ROS2 node initializations</span>
<span class="linenos"> 37</span><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">initialize_autopilot</span><span class="p">();</span>
<span class="linenos"> 38</span><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">initialize_publishers</span><span class="p">();</span>
<span class="linenos"> 39</span><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">initialize_subscribers</span><span class="p">();</span>
<span class="linenos"> 40</span><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">initialize_services</span><span class="p">();</span>
<span class="linenos"> 41</span>
<span class="linenos"> 42</span><span class="w">    </span><span class="c1">// Subscriber callbacks to get the current state of the vehicle</span>
<span class="linenos"> 43</span><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">state_callback</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">nav_msgs</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">Odometry</span><span class="o">::</span><span class="n">ConstSharedPtr</span><span class="w"> </span><span class="n">msg</span><span class="p">);</span>
<span class="linenos"> 44</span><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">status_callback</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">pegasus_msgs</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">Status</span><span class="o">::</span><span class="n">ConstSharedPtr</span><span class="w"> </span><span class="n">msg</span><span class="p">);</span>
<span class="linenos"> 45</span><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">vehicle_constants_callback</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">pegasus_msgs</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">VehicleConstants</span><span class="o">::</span><span class="n">ConstSharedPtr</span><span class="w"> </span><span class="n">msg</span><span class="p">);</span>
<span class="linenos"> 46</span>
<span class="linenos"> 47</span><span class="w">    </span><span class="c1">// Services callbacks to set the operation mode of the autopilot</span>
<span class="linenos"> 48</span><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">change_mode_callback</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">pegasus_msgs</span><span class="o">::</span><span class="n">srv</span><span class="o">::</span><span class="n">SetMode</span><span class="o">::</span><span class="n">Request</span><span class="o">&gt;</span><span class="w"> </span><span class="n">request</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">pegasus_msgs</span><span class="o">::</span><span class="n">srv</span><span class="o">::</span><span class="n">SetMode</span><span class="o">::</span><span class="n">Response</span><span class="o">&gt;</span><span class="w"> </span><span class="n">response</span><span class="p">);</span>
<span class="linenos"> 49</span>
<span class="linenos"> 50</span><span class="w">    </span><span class="c1">// ROS 2 service to change the operation mode</span>
<span class="linenos"> 51</span><span class="w">    </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">Service</span><span class="o">&lt;</span><span class="n">pegasus_msgs</span><span class="o">::</span><span class="n">srv</span><span class="o">::</span><span class="n">SetMode</span><span class="o">&gt;::</span><span class="n">SharedPtr</span><span class="w"> </span><span class="n">change_mode_service_</span><span class="p">;</span>
<span class="linenos"> 52</span>
<span class="linenos"> 53</span><span class="w">    </span><span class="c1">// ROS2 publishers</span>
<span class="linenos"> 54</span><span class="w">    </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">Publisher</span><span class="o">&lt;</span><span class="n">pegasus_msgs</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">AutopilotStatus</span><span class="o">&gt;::</span><span class="n">SharedPtr</span><span class="w"> </span><span class="n">status_publisher_</span><span class="p">;</span>
<span class="linenos"> 55</span><span class="w">    </span>
<span class="linenos"> 56</span><span class="w">    </span><span class="c1">// ROS2 subscribers</span>
<span class="linenos"> 57</span><span class="w">    </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">Subscription</span><span class="o">&lt;</span><span class="n">nav_msgs</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">Odometry</span><span class="o">&gt;::</span><span class="n">SharedPtr</span><span class="w"> </span><span class="n">state_subscriber_</span><span class="p">;</span>
<span class="linenos"> 58</span><span class="w">    </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">Subscription</span><span class="o">&lt;</span><span class="n">pegasus_msgs</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">Status</span><span class="o">&gt;::</span><span class="n">SharedPtr</span><span class="w"> </span><span class="n">status_subscriber_</span><span class="p">;</span>
<span class="linenos"> 59</span><span class="w">    </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">Subscription</span><span class="o">&lt;</span><span class="n">pegasus_msgs</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">VehicleConstants</span><span class="o">&gt;::</span><span class="n">SharedPtr</span><span class="w"> </span><span class="n">vehicle_constants_subscriber_</span><span class="p">;</span>
<span class="linenos"> 60</span>
<span class="linenos"> 61</span><span class="w">    </span><span class="c1">// ROS2 messages</span>
<span class="linenos"> 62</span><span class="w">    </span><span class="n">pegasus_msgs</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">AutopilotStatus</span><span class="w"> </span><span class="n">status_msg_</span><span class="p">;</span>
<span class="linenos"> 63</span><span class="w">    </span><span class="n">pegasus_msgs</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">VehicleConstants</span><span class="w"> </span><span class="n">vehicle_constants_msg_</span><span class="p">;</span>
<span class="linenos"> 64</span>
<span class="linenos"> 65</span><span class="w">    </span><span class="c1">// ROS 2 timer to handle the control modes, update the controllers and publish the control commands</span>
<span class="linenos"> 66</span><span class="w">    </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">TimerBase</span><span class="o">::</span><span class="n">SharedPtr</span><span class="w"> </span><span class="n">timer_</span><span class="p">;</span>
<span class="linenos"> 67</span>
<span class="linenos"> 68</span><span class="w">    </span><span class="c1">// Modes of operation of the autopilot</span>
<span class="linenos"> 69</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="n">autopilot</span><span class="o">::</span><span class="n">Mode</span><span class="o">::</span><span class="n">UniquePtr</span><span class="o">&gt;</span><span class="w"> </span><span class="n">operating_modes_</span><span class="p">;</span>
<span class="linenos"> 70</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">valid_transitions_</span><span class="p">;</span>
<span class="linenos"> 71</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="w"> </span><span class="n">fallback_modes_</span><span class="p">;</span>
<span class="linenos"> 72</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="w"> </span><span class="n">on_finish_modes_</span><span class="p">;</span>
<span class="linenos"> 73</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="w"> </span><span class="n">geofencing_violation_fallback_</span><span class="p">;</span>
<span class="linenos"> 74</span>
<span class="linenos"> 75</span><span class="w">    </span><span class="c1">// Configuration for the operation modes for the autopilot</span>
<span class="linenos"> 76</span><span class="w">    </span><span class="n">Mode</span><span class="o">::</span><span class="n">Config</span><span class="w"> </span><span class="n">mode_config_</span><span class="p">;</span>
<span class="linenos"> 77</span>
<span class="linenos"> 78</span><span class="w">    </span><span class="c1">// Current state and status of the vehicle</span>
<span class="linenos"> 79</span><span class="w">    </span><span class="n">State</span><span class="w"> </span><span class="n">state_</span><span class="p">;</span>
<span class="linenos"> 80</span><span class="w">    </span><span class="n">VehicleStatus</span><span class="w"> </span><span class="n">status_</span><span class="p">;</span>
<span class="linenos"> 81</span><span class="w">    </span><span class="n">VehicleConstants</span><span class="w"> </span><span class="n">vehicle_constants_</span><span class="p">;</span>
<span class="linenos"> 82</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">current_mode_</span><span class="p">{</span><span class="s">&quot;Uninitialized&quot;</span><span class="p">};</span>
<span class="linenos"> 83</span>
<span class="linenos"> 84</span><span class="w">    </span><span class="c1">// Low level controllers for reference tracking</span>
<span class="linenos"> 85</span><span class="w">    </span><span class="n">Controller</span><span class="o">::</span><span class="n">Config</span><span class="w"> </span><span class="n">controller_config_</span><span class="p">;</span>
<span class="linenos"> 86</span><span class="w">    </span><span class="n">autopilot</span><span class="o">::</span><span class="n">Controller</span><span class="o">::</span><span class="n">SharedPtr</span><span class="w"> </span><span class="n">controller_</span><span class="p">{</span><span class="k">nullptr</span><span class="p">};</span>
<span class="hll"><span class="linenos"> 87</span>
</span><span class="hll"><span class="linenos"> 88</span><span class="w">    </span><span class="c1">// Geofencing object to check if the vehicle is inside the geofence</span>
</span><span class="linenos"> 89</span><span class="w">    </span><span class="n">Geofencing</span><span class="o">::</span><span class="n">Config</span><span class="w"> </span><span class="n">geofencing_config_</span><span class="p">;</span>
<span class="linenos"> 90</span><span class="w">    </span><span class="n">autopilot</span><span class="o">::</span><span class="n">Geofencing</span><span class="o">::</span><span class="n">UniquePtr</span><span class="w"> </span><span class="n">geofencing_</span><span class="p">{</span><span class="k">nullptr</span><span class="p">};</span>
<span class="linenos"> 91</span>
<span class="linenos"> 92</span><span class="w">    </span><span class="c1">// Trajectory manager to handle complex trajectories and motion planning</span>
<span class="linenos"> 93</span><span class="w">    </span><span class="n">TrajectoryManager</span><span class="o">::</span><span class="n">Config</span><span class="w"> </span><span class="n">trajectory_manager_config_</span><span class="p">;</span>
<span class="linenos"> 94</span><span class="w">    </span><span class="n">autopilot</span><span class="o">::</span><span class="n">TrajectoryManager</span><span class="o">::</span><span class="n">SharedPtr</span><span class="w"> </span><span class="n">trajectory_manager_</span><span class="p">{</span><span class="k">nullptr</span><span class="p">};</span>
<span class="linenos"> 95</span>
<span class="linenos"> 96</span><span class="w">    </span><span class="c1">// Auxiliar counter to keep track when forcing a mode change</span>
<span class="linenos"> 97</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">force_change_counter_</span><span class="p">{</span><span class="mi">0</span><span class="p">};</span>
<span class="linenos"> 98</span>
<span class="linenos"> 99</span><span class="w">    </span><span class="c1">// Auxiliar variable used to keep track of time</span>
<span class="linenos">100</span><span class="w">    </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">Time</span><span class="w"> </span><span class="n">last_time_</span><span class="p">;</span>
<span class="linenos">101</span>
<span class="linenos">102</span><span class="w">    </span><span class="c1">// Auxiliar flag to check if the operating mode has finished</span>
<span class="linenos">103</span><span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">mode_finished_</span><span class="p">{</span><span class="nb">false</span><span class="p">};</span>
<span class="linenos">104</span>
<span class="linenos">105</span><span class="w">    </span><span class="c1">// Class loaders for the plugins</span>
<span class="linenos">106</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">pluginlib</span><span class="o">::</span><span class="n">ClassLoader</span><span class="o">&lt;</span><span class="n">autopilot</span><span class="o">::</span><span class="n">Mode</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">mode_loader_</span><span class="p">;</span>
<span class="linenos">107</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">pluginlib</span><span class="o">::</span><span class="n">ClassLoader</span><span class="o">&lt;</span><span class="n">autopilot</span><span class="o">::</span><span class="n">Controller</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">controller_loader_</span><span class="p">;</span>
<span class="linenos">108</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">pluginlib</span><span class="o">::</span><span class="n">ClassLoader</span><span class="o">&lt;</span><span class="n">autopilot</span><span class="o">::</span><span class="n">Geofencing</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">geofencing_loader_</span><span class="p">;</span>
<span class="linenos">109</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">pluginlib</span><span class="o">::</span><span class="n">ClassLoader</span><span class="o">&lt;</span><span class="n">autopilot</span><span class="o">::</span><span class="n">TrajectoryManager</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">trajectory_manager_loader_</span><span class="p">;</span>
<span class="linenos">110</span><span class="p">};</span>
<span class="linenos">111</span>
<span class="linenos">112</span><span class="p">}</span><span class="w"> </span><span class="c1">// namespace autopilot</span>
</pre></div>
</div>
</section>
<section id="explanation">
<h2>2. Explanation<a class="headerlink" href="#explanation" title="Permalink to this heading"></a></h2>
<p>In order to</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos">87</span><span class="w">    </span><span class="c1">// Function that executes periodically the control loop of each operation mode</span>
<span class="linenos">88</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">update</span><span class="p">();</span>
</pre></div>
</div>
</section>
<section id="autopilot-configuration-file">
<h2>3. Autopilot Configuration File<a class="headerlink" href="#autopilot-configuration-file" title="Permalink to this heading"></a></h2>
<p>In order to</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="nt">/**</span><span class="p">:</span>
<span class="linenos"> 2</span><span class="w">  </span><span class="nt">ros__parameters</span><span class="p">:</span>
<span class="linenos"> 3</span><span class="w">    </span><span class="nt">autopilot</span><span class="p">:</span>
<span class="linenos"> 4</span><span class="w">      </span><span class="c1"># Update rate</span>
<span class="linenos"> 5</span><span class="w">      </span><span class="nt">rate</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">50.0</span><span class="w"> </span><span class="c1"># Hz</span>
<span class="linenos"> 6</span><span class="w">      </span><span class="c1"># ----------------------------------------------------------------------------------------------------------</span>
<span class="linenos"> 7</span><span class="w">      </span><span class="c1"># Definition of the controller that will perform the tracking of references of the different operation modes</span>
<span class="linenos"> 8</span><span class="w">      </span><span class="c1"># ----------------------------------------------------------------------------------------------------------</span>
<span class="linenos"> 9</span><span class="w">      </span><span class="nt">controller</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;MellingerController&quot;</span>
<span class="linenos">10</span><span class="w">      </span><span class="c1"># Configurations needed by the PX4 controller</span>
<span class="linenos">11</span><span class="w">      </span><span class="nt">OnboardController</span><span class="p">:</span>
<span class="linenos">12</span><span class="w">        </span><span class="nt">publishers</span><span class="p">:</span>
<span class="linenos">13</span><span class="w">          </span><span class="nt">control_position</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;fmu/in/position&quot;</span>
<span class="linenos">14</span><span class="w">          </span><span class="nt">control_attitude</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;fmu/in/force/attitude&quot;</span>
<span class="linenos">15</span><span class="w">          </span><span class="nt">control_attitude_rate</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;fmu/in/force/attitude_rate&quot;</span>
<span class="linenos">16</span><span class="w">      </span><span class="nt">PIDController</span><span class="p">:</span>
<span class="linenos">17</span><span class="w">        </span><span class="nt">publishers</span><span class="p">:</span>
<span class="linenos">18</span><span class="w">          </span><span class="nt">control_attitude</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;fmu/in/force/attitude&quot;</span>
<span class="linenos">19</span><span class="w">          </span><span class="nt">control_attitude_rate</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;fmu/in/force/attitude_rate&quot;</span>
<span class="linenos">20</span><span class="w">          </span><span class="nt">pid_debug_topic</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;autopilot/statistics/pid&quot;</span>
<span class="linenos">21</span><span class="w">        </span><span class="c1"># Gains for position PIDs on [x, y, z]</span>
<span class="linenos">22</span><span class="w">        </span><span class="nt">gains</span><span class="p">:</span>
<span class="linenos">23</span><span class="w">          </span><span class="nt">kp</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">8.0</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">8.0</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">8.0</span><span class="p p-Indicator">]</span><span class="w">   </span><span class="c1"># Proportional gain</span>
<span class="linenos">24</span><span class="w">          </span><span class="nt">kd</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">3.0</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">3.0</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">3.0</span><span class="p p-Indicator">]</span><span class="w">   </span><span class="c1"># Derivative gain</span>
<span class="linenos">25</span><span class="w">          </span><span class="nt">ki</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">0.2</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">0.2</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">0.1</span><span class="p p-Indicator">]</span><span class="w">   </span><span class="c1"># Integral gain</span>
<span class="linenos">26</span><span class="w">          </span><span class="nt">kff</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">1.0</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">1.0</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">1.0</span><span class="p p-Indicator">]</span><span class="w">  </span><span class="c1"># Feed-forward gain</span>
<span class="linenos">27</span><span class="w">          </span><span class="nt">min_output</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">-20.0</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">-20.0</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">-20.0</span><span class="p p-Indicator">]</span><span class="w"> </span><span class="c1"># Minimum output of each PID</span>
<span class="linenos">28</span><span class="w">          </span><span class="nt">max_output</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="w"> </span><span class="nv">20.0</span><span class="p p-Indicator">,</span><span class="w">  </span><span class="nv">20.0</span><span class="p p-Indicator">,</span><span class="w">  </span><span class="nv">20.0</span><span class="p p-Indicator">]</span>
<span class="linenos">29</span><span class="w">      </span><span class="nt">MellingerController</span><span class="p">:</span>
<span class="linenos">30</span><span class="w">        </span><span class="nt">publishers</span><span class="p">:</span>
<span class="linenos">31</span><span class="w">          </span><span class="nt">control_attitude</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;fmu/in/force/attitude&quot;</span>
<span class="linenos">32</span><span class="w">          </span><span class="nt">control_attitude_rate</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;fmu/in/force/attitude_rate&quot;</span>
<span class="linenos">33</span><span class="w">          </span><span class="nt">debug_topic</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;autopilot/statistics/mellinger&quot;</span>
<span class="linenos">34</span><span class="w">        </span><span class="nt">gains</span><span class="p">:</span>
<span class="linenos">35</span><span class="w">          </span><span class="nt">kp</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">10.0</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">10.0</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">10.0</span><span class="p p-Indicator">]</span><span class="w">    </span><span class="c1"># Proportional gain</span>
<span class="linenos">36</span><span class="w">          </span><span class="nt">kd</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">9.0</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">9.0</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">9.0</span><span class="p p-Indicator">]</span><span class="w">    </span><span class="c1"># Derivative gain</span>
<span class="linenos">37</span><span class="w">          </span><span class="nt">ki</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">0.2</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">0.2</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">0.1</span><span class="p p-Indicator">]</span><span class="w">    </span><span class="c1"># Integral gain</span>
<span class="linenos">38</span><span class="w">          </span><span class="nt">kr</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">5.0</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">5.0</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">5.0</span><span class="p p-Indicator">]</span><span class="w">    </span><span class="c1"># Attitude error gain</span>
<span class="linenos">39</span><span class="w">          </span><span class="nt">min_output</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">-100.0</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">-100.0</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">-100.0</span><span class="p p-Indicator">]</span><span class="w">  </span><span class="c1"># Minimum output of each PID</span>
<span class="linenos">40</span><span class="w">          </span><span class="nt">max_output</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="w"> </span><span class="nv">100.0</span><span class="p p-Indicator">,</span><span class="w">  </span><span class="nv">100.0</span><span class="p p-Indicator">,</span><span class="w">  </span><span class="nv">100.0</span><span class="p p-Indicator">]</span><span class="w">  </span><span class="c1"># Maximum output of each PID</span>
</pre></div>
</div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="linenos">41</span><span class="w">      </span><span class="c1"># ----------------------------------------------------------------------------------------------------------</span>
<span class="linenos">42</span><span class="w">      </span><span class="c1"># Definition of the geofencing mechanism that will keep the vehicle in safe places</span>
<span class="linenos">43</span><span class="w">      </span><span class="c1"># ----------------------------------------------------------------------------------------------------------</span>
<span class="linenos">44</span><span class="w">      </span><span class="nt">geofencing</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;BoxGeofencing&quot;</span>
<span class="linenos">45</span><span class="w">      </span><span class="nt">BoxGeofencing</span><span class="p">:</span>
<span class="linenos">46</span><span class="w">        </span><span class="nt">limits_x</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">-10.0</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">10.0</span><span class="p p-Indicator">]</span>
<span class="linenos">47</span><span class="w">        </span><span class="nt">limits_y</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">-10.0</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">10.0</span><span class="p p-Indicator">]</span>
<span class="linenos">48</span><span class="w">        </span><span class="nt">limits_z</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">-10.0</span><span class="p p-Indicator">,</span><span class="w">  </span><span class="nv">1.0</span><span class="p p-Indicator">]</span><span class="w"> </span><span class="c1"># NED Coordinades (z-negative is up)</span>
</pre></div>
</div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="linenos">49</span><span class="w">      </span><span class="c1"># ----------------------------------------------------------------------------------------------------------</span>
<span class="linenos">50</span><span class="w">      </span><span class="c1"># Definition of the trajectory manager that generates parameterized trajectories to be followed</span>
<span class="linenos">51</span><span class="w">      </span><span class="c1"># ----------------------------------------------------------------------------------------------------------</span>
<span class="linenos">52</span><span class="w">      </span><span class="nt">trajectory_manager</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;StaticTrajectoryManager&quot;</span>
<span class="linenos">53</span><span class="w">      </span><span class="nt">StaticTrajectoryManager</span><span class="p">:</span>
<span class="linenos">54</span><span class="w">        </span><span class="nt">trajectories</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;ArcFactory&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;LineFactory&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;CircleFactory&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;LemniscateFactory&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;CSVFactory&quot;</span><span class="p p-Indicator">]</span>
<span class="linenos">55</span><span class="w">        </span><span class="nt">services</span><span class="p">:</span>
<span class="linenos">56</span><span class="w">          </span><span class="nt">reset_trajectory</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;autopilot/trajectory/reset&quot;</span>
<span class="linenos">57</span><span class="w">        </span><span class="c1"># Individual trajectory setup</span>
<span class="linenos">58</span><span class="w">        </span><span class="nt">ArcFactory</span><span class="p">:</span>
<span class="linenos">59</span><span class="w">          </span><span class="nt">service</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;autopilot/trajectory/add_arc&quot;</span>
<span class="linenos">60</span><span class="w">        </span><span class="nt">LineFactory</span><span class="p">:</span>
<span class="linenos">61</span><span class="w">          </span><span class="nt">service</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;autopilot/trajectory/add_line&quot;</span>
<span class="linenos">62</span><span class="w">        </span><span class="nt">CircleFactory</span><span class="p">:</span>
<span class="linenos">63</span><span class="w">          </span><span class="nt">service</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;autopilot/trajectory/add_circle&quot;</span>
<span class="linenos">64</span><span class="w">        </span><span class="nt">LemniscateFactory</span><span class="p">:</span>
<span class="linenos">65</span><span class="w">          </span><span class="nt">service</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;autopilot/trajectory/add_lemniscate&quot;</span>
<span class="linenos">66</span><span class="w">        </span><span class="nt">CSVFactory</span><span class="p">:</span>
<span class="linenos">67</span><span class="w">          </span><span class="nt">service</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;autopilot/trajectory/add_csv&quot;</span>
</pre></div>
</div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 68</span><span class="w">      </span><span class="c1"># ---------------------------------------------------------------------------------------------------------</span>
<span class="linenos"> 69</span><span class="w">      </span><span class="c1"># Define the default operation mode (the one which the autopilot initializes at)</span>
<span class="linenos"> 70</span><span class="w">      </span><span class="c1"># ---------------------------------------------------------------------------------------------------------</span>
<span class="linenos"> 71</span><span class="w">      </span><span class="nt">default_mode</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;DisarmMode&quot;</span>
<span class="linenos"> 72</span><span class="w">      </span><span class="c1"># Define all the existing operation modes</span>
<span class="linenos"> 73</span><span class="w">      </span><span class="nt">modes</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;DisarmMode&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;ArmMode&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;TakeoffMode&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;LandMode&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;HoldMode&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;WaypointMode&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;FollowTrajectoryMode&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;PassThroughMode&quot;</span><span class="p p-Indicator">]</span>
<span class="linenos"> 74</span><span class="w">      </span><span class="c1"># Configurations of each operating mode:</span>
<span class="linenos"> 75</span><span class="w">      </span><span class="c1"># 1) Define the valid transitions from a given operation mode to other operation modes</span>
<span class="linenos"> 76</span><span class="w">      </span><span class="c1"># 2) Fallback mode if something goes wrong</span>
<span class="linenos"> 77</span><span class="w">      </span><span class="c1"># 3) Other specific operating mode configuration</span>
<span class="linenos"> 78</span><span class="w">      </span><span class="nt">DisarmMode</span><span class="p">:</span><span class="w"> </span>
<span class="linenos"> 79</span><span class="w">        </span><span class="nt">valid_transitions</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;ArmMode&quot;</span><span class="p p-Indicator">]</span>
<span class="linenos"> 80</span><span class="w">        </span><span class="nt">fallback</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;DisarmMode&quot;</span>
<span class="linenos"> 81</span><span class="w">        </span><span class="nt">disarm_service</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;fmu/kill_switch&quot;</span>
<span class="linenos"> 82</span><span class="w">      </span><span class="nt">ArmMode</span><span class="p">:</span><span class="w"> </span>
<span class="linenos"> 83</span><span class="w">        </span><span class="nt">valid_transitions</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;DisarmMode&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;TakeoffMode&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;HoldMode&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;WaypointMode&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;FollowTrajectoryMode&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;PassThroughMode&quot;</span><span class="p p-Indicator">]</span>
<span class="linenos"> 84</span><span class="w">        </span><span class="nt">fallback</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;DisarmMode&quot;</span>
<span class="linenos"> 85</span><span class="w">        </span><span class="nt">geofencing_violation_fallback</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;DisarmMode&quot;</span>
<span class="linenos"> 86</span><span class="w">        </span><span class="nt">arm_service</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;fmu/arm&quot;</span>
<span class="linenos"> 87</span><span class="w">        </span><span class="nt">offboard_service</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;fmu/offboard&quot;</span>
<span class="linenos"> 88</span><span class="w">      </span><span class="nt">TakeoffMode</span><span class="p">:</span><span class="w"> </span>
<span class="linenos"> 89</span><span class="w">        </span><span class="nt">valid_transitions</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;LandMode&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;HoldMode&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;WaypointMode&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;FollowTrajectoryMode&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;PassThroughMode&quot;</span><span class="p p-Indicator">]</span>
<span class="linenos"> 90</span><span class="w">        </span><span class="nt">fallback</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;HoldMode&quot;</span>
<span class="linenos"> 91</span><span class="w">        </span><span class="nt">on_finish</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;HoldMode&quot;</span>
<span class="linenos"> 92</span><span class="w">        </span><span class="nt">geofencing_violation_fallback</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;HoldMode&quot;</span>
<span class="linenos"> 93</span><span class="w">        </span><span class="nt">takeoff_altitude</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">-1.0</span><span class="w"> </span><span class="c1"># m (NED)</span>
<span class="linenos"> 94</span><span class="w">        </span><span class="nt">set_takeoff_altitude_service</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;autopilot/set_takeoff&quot;</span>
<span class="linenos"> 95</span><span class="w">      </span><span class="nt">LandMode</span><span class="p">:</span><span class="w"> </span>
<span class="linenos"> 96</span><span class="w">        </span><span class="nt">valid_transitions</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;DisarmMode&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;ArmMode&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;TakeoffMode&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;HoldMode&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;WaypointMode&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;FollowTrajectoryMode&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;PassThroughMode&quot;</span><span class="p p-Indicator">]</span>
<span class="linenos"> 97</span><span class="w">        </span><span class="nt">fallback</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;HoldMode&quot;</span>
<span class="linenos"> 98</span><span class="w">        </span><span class="nt">on_finish</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;DisarmMode&quot;</span>
<span class="linenos"> 99</span><span class="w">        </span><span class="nt">land_speed</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.2</span><span class="w"> </span><span class="c1"># m/s</span>
<span class="linenos">100</span><span class="w">        </span><span class="nt">land_detected_treshold</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.1</span><span class="w"> </span><span class="c1"># m/s</span>
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../setup/reference_frames.html" class="btn btn-neutral float-left" title="Standards" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="modes.html" class="btn btn-neutral float-right" title="Modes" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Marcelo Jacinto.</p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>