<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Modes &mdash; Pegasus  documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Controllers" href="controllers.html" />
    <link rel="prev" title="Autopilot" href="autopilot.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #000000" >

          
          
          <a href="../../index.html">
            
              <img src="../../_static/logo.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../setup/installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../setup/reference_frames.html">Standards</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Features</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="autopilot.html">Autopilot</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Modes</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#mode-interface">0. Mode Interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="#provided-state-machine-modes">1. Provided State Machine Modes</a></li>
<li class="toctree-l2"><a class="reference internal" href="#adding-custom-modes-to-the-state-machine">2. Adding Custom Modes to the State Machine</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="controllers.html">Controllers</a></li>
<li class="toctree-l1"><a class="reference internal" href="geofencing.html">Geofencing</a></li>
<li class="toctree-l1"><a class="reference internal" href="trajectory_manager.html">Trajectory Manager</a></li>
<li class="toctree-l1"><a class="reference internal" href="../console/terminal_console.html">Terminal console</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Simulation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../simulation/gazebo_classic.html">Gazebo Classic</a></li>
<li class="toctree-l1"><a class="reference internal" href="../simulation/pegasus_simulator.html">Pegasus Simulator</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Vehicles</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../vehicles/pegasus.html">Pegasus Drone v1.0.0</a></li>
<li class="toctree-l1"><a class="reference internal" href="../vehicles/kopis.html">Kopis Drone Setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="../vehicles/snapdragon.html">Snapdragon Drone</a></li>
<li class="toctree-l1"><a class="reference internal" href="../vehicles/intel_aero.html">Intel Aero</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Flight Arena</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../arena/arena.html">Taguspark Flight Arena</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">References</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../references/license.html">License</a></li>
<li class="toctree-l1"><a class="reference internal" href="../references/bibliography.html">Bibliography</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #000000" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Pegasus</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Modes</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/source/features/modes.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="modes">
<h1>Modes<a class="headerlink" href="#modes" title="Permalink to this heading"></a></h1>
<p>An operation <code class="docutils literal notranslate"><span class="pre">mode</span></code> is a state in which the autopilot can be in. The autopilot can be in only one mode at a time.
In this section we provide an overview on the autopilot operating modes and how to add custom modes to the state machine.</p>
<p>Depending on the target application, an autopilot <code class="docutils literal notranslate"><span class="pre">mode</span></code> can be used to define a new behaviour for the vehicle to execute,
or be used to prototype a controller as well. For instance, if you want to prototype a new controller to be used only for following
a specific trajectory, then it might make sense to implement it as a <code class="docutils literal notranslate"><span class="pre">mode</span></code> rather than a <code class="docutils literal notranslate"><span class="pre">controller</span></code> that is used by all the other available modes.</p>
<p>This page is structured as follows:</p>
<ul class="simple">
<li><p>Section <a class="reference internal" href="#mode-interface"><span class="std std-ref">0. Mode Interface</span></a> introduces the “Mode” class that defines the interface for the autopilot operating modes.</p></li>
<li><p>Section <a class="reference internal" href="#provided-state-machine-modes"><span class="std std-ref">1. Provided State Machine Modes</span></a> provides an overview of the provided operating modes and where they are implemented.</p></li>
<li><p>Section <a class="reference internal" href="#adding-custom-modes-to-the-state-machine"><span class="std std-ref">2. Adding Custom Modes to the State Machine</span></a> provides a step-by-step guide on how to add custom operating modes to the state machine.</p></li>
</ul>
<section id="mode-interface">
<h2>0. Mode Interface<a class="headerlink" href="#mode-interface" title="Permalink to this heading"></a></h2>
<p>The interface for the autopilot operating modes is defined in the autopilot package under the <code class="docutils literal notranslate"><span class="pre">pegasus_autopilot/autopilot/include/autopilot/mode.hpp</span></code> header file.
The <code class="docutils literal notranslate"><span class="pre">Mode</span></code> class is an abstract class that defines the interface for the autopilot operating modes.</p>
<p>The autopilot operating modes must inherit from the <code class="docutils literal notranslate"><span class="pre">Mode</span></code> class and implement the methods
highlighted in yellow (lines 42-47) in the code snippet below:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="k">namespace</span><span class="w"> </span><span class="nn">autopilot</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="k">class</span><span class="w"> </span><span class="nc">Mode</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 4</span>
<span class="linenos"> 5</span><span class="k">public</span><span class="o">:</span>
<span class="linenos"> 6</span>
<span class="linenos"> 7</span><span class="w">    </span><span class="k">using</span><span class="w"> </span><span class="n">SharedPtr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">Mode</span><span class="o">&gt;</span><span class="p">;</span>
<span class="linenos"> 8</span><span class="w">    </span><span class="k">using</span><span class="w"> </span><span class="n">UniquePtr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">Mode</span><span class="o">&gt;</span><span class="p">;</span>
<span class="linenos"> 9</span><span class="w">    </span><span class="k">using</span><span class="w"> </span><span class="n">WeakPtr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">weak_ptr</span><span class="o">&lt;</span><span class="n">Mode</span><span class="o">&gt;</span><span class="p">;</span>
<span class="linenos">10</span>
<span class="linenos">11</span><span class="w">    </span><span class="c1">// Configuration for the operation mode</span>
<span class="linenos">12</span><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">Config</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">13</span><span class="w">        </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">Node</span><span class="o">::</span><span class="n">SharedPtr</span><span class="w"> </span><span class="n">node</span><span class="p">;</span><span class="w">                                           </span><span class="c1">// ROS 2 node ptr (in case the mode needs to create publishers, subscribers, etc.)</span>
<span class="linenos">14</span><span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">function</span><span class="o">&lt;</span><span class="n">State</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="n">get_vehicle_state</span><span class="p">;</span><span class="w">                               </span><span class="c1">// Function pointer to get the current state of the vehicle      </span>
<span class="linenos">15</span><span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">function</span><span class="o">&lt;</span><span class="n">VehicleStatus</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="n">get_vehicle_status</span><span class="p">;</span><span class="w">                      </span><span class="c1">// Function pointer to get the current status of the vehicle  </span>
<span class="linenos">16</span><span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">function</span><span class="o">&lt;</span><span class="n">VehicleConstants</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="n">get_vehicle_constants</span><span class="p">;</span><span class="w">                </span><span class="c1">// Function pointer to get the current dynamical constants of the vehicle    </span>
<span class="linenos">17</span><span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">function</span><span class="o">&lt;</span><span class="kt">void</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="n">signal_mode_finished</span><span class="p">;</span><span class="w">                             </span><span class="c1">// Function pointer to signal that the mode has finished operating</span>
<span class="linenos">18</span><span class="w">        </span><span class="n">Controller</span><span class="o">::</span><span class="n">SharedPtr</span><span class="w"> </span><span class="n">controller</span><span class="p">;</span><span class="w">                                       </span><span class="c1">// Controller to be used by the mode</span>
<span class="linenos">19</span><span class="w">        </span><span class="n">TrajectoryManager</span><span class="o">::</span><span class="n">SharedPtr</span><span class="w"> </span><span class="n">trajectory_manager</span><span class="p">;</span><span class="w">                        </span><span class="c1">// Trajectory manager that can be used by some modes</span>
<span class="linenos">20</span><span class="w">    </span><span class="p">};</span>
<span class="linenos">21</span>
<span class="linenos">22</span><span class="w">    </span><span class="c1">// Custom constructor like function - as we must have the default constructor for the pluginlib</span>
<span class="linenos">23</span><span class="w">    </span><span class="kr">inline</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">initialize_mode</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Mode</span><span class="o">::</span><span class="n">Config</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">config</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">24</span>
<span class="linenos">25</span><span class="w">        </span><span class="c1">// Initialize the base class</span>
<span class="linenos">26</span><span class="w">        </span><span class="n">node_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">config</span><span class="p">.</span><span class="n">node</span><span class="p">;</span>
<span class="linenos">27</span><span class="w">        </span><span class="n">get_vehicle_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">config</span><span class="p">.</span><span class="n">get_vehicle_state</span><span class="p">;</span>
<span class="linenos">28</span><span class="w">        </span><span class="n">get_vehicle_status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">config</span><span class="p">.</span><span class="n">get_vehicle_status</span><span class="p">;</span>
<span class="linenos">29</span><span class="w">        </span><span class="n">get_vehicle_constants</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">config</span><span class="p">.</span><span class="n">get_vehicle_constants</span><span class="p">;</span><span class="w">        </span>
<span class="linenos">30</span><span class="w">        </span><span class="n">signal_mode_finished</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">config</span><span class="p">.</span><span class="n">signal_mode_finished</span><span class="p">;</span>
<span class="linenos">31</span>
<span class="linenos">32</span><span class="w">        </span><span class="c1">// Initialize the controller</span>
<span class="linenos">33</span><span class="w">        </span><span class="n">controller_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">config</span><span class="p">.</span><span class="n">controller</span><span class="p">;</span>
<span class="linenos">34</span>
<span class="linenos">35</span><span class="w">        </span><span class="c1">// Initialize the trajectory manager</span>
<span class="linenos">36</span><span class="w">        </span><span class="n">trajectory_manager_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">config</span><span class="p">.</span><span class="n">trajectory_manager</span><span class="p">;</span>
<span class="linenos">37</span>
<span class="linenos">38</span><span class="w">        </span><span class="c1">// Initialize the derived class</span>
<span class="linenos">39</span><span class="w">        </span><span class="n">initialize</span><span class="p">();</span>
<span class="linenos">40</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">41</span>
<span class="hll"><span class="linenos">42</span><span class="w">    </span><span class="c1">// Methods that can be implemented by derived classes</span>
</span><span class="hll"><span class="linenos">43</span><span class="w">    </span><span class="c1">// that are executed by the state machine when entering, exiting or updating the mode</span>
</span><span class="hll"><span class="linenos">44</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">initialize</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span class="hll"><span class="linenos">45</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="nf">enter</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span class="hll"><span class="linenos">46</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="nf">exit</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span class="hll"><span class="linenos">47</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">dt</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span class="linenos">48</span>
<span class="linenos">49</span><span class="k">protected</span><span class="o">:</span>
<span class="linenos">50</span>
<span class="linenos">51</span><span class="w">    </span><span class="c1">// The ROS 2 node</span>
<span class="linenos">52</span><span class="w">    </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">Node</span><span class="o">::</span><span class="n">SharedPtr</span><span class="w"> </span><span class="n">node_</span><span class="p">{</span><span class="k">nullptr</span><span class="p">};</span>
<span class="linenos">53</span>
<span class="linenos">54</span><span class="w">    </span><span class="c1">// The controller object that can be used by each mode to track references</span>
<span class="linenos">55</span><span class="w">    </span><span class="n">Controller</span><span class="o">::</span><span class="n">SharedPtr</span><span class="w"> </span><span class="n">controller_</span><span class="p">{</span><span class="k">nullptr</span><span class="p">};</span>
<span class="linenos">56</span>
<span class="linenos">57</span><span class="w">    </span><span class="c1">// The trajectory manager object that can be used by each mode to generate references to track</span>
<span class="linenos">58</span><span class="w">    </span><span class="n">TrajectoryManager</span><span class="o">::</span><span class="n">SharedPtr</span><span class="w"> </span><span class="n">trajectory_manager_</span><span class="p">{</span><span class="k">nullptr</span><span class="p">};</span>
<span class="linenos">59</span>
<span class="linenos">60</span><span class="w">    </span><span class="c1">// Function pointer which will be instantiated with the function pointers passed in the configuration</span>
<span class="linenos">61</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">function</span><span class="o">&lt;</span><span class="n">State</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="n">get_vehicle_state</span><span class="p">{</span><span class="k">nullptr</span><span class="p">};</span>
<span class="linenos">62</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">function</span><span class="o">&lt;</span><span class="n">VehicleStatus</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="n">get_vehicle_status</span><span class="p">{</span><span class="k">nullptr</span><span class="p">};</span>
<span class="linenos">63</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">function</span><span class="o">&lt;</span><span class="n">VehicleConstants</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="n">get_vehicle_constants</span><span class="p">{</span><span class="k">nullptr</span><span class="p">};</span>
<span class="linenos">64</span>
<span class="linenos">65</span><span class="w">    </span><span class="c1">// Function pointer to signal that the mode has finished operating</span>
<span class="linenos">66</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">function</span><span class="o">&lt;</span><span class="kt">void</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="n">signal_mode_finished</span><span class="p">{</span><span class="k">nullptr</span><span class="p">};</span>
<span class="linenos">67</span><span class="p">};</span>
<span class="linenos">68</span>
<span class="linenos">69</span><span class="p">}</span><span class="w"> </span><span class="c1">// namespace autopilot</span>
</pre></div>
</div>
<p>Additionally, the <code class="docutils literal notranslate"><span class="pre">Mode</span></code> class provides methods to get:</p>
<ol class="arabic simple">
<li><p>The current <code class="docutils literal notranslate"><span class="pre">State</span></code> of the vehicle can be accessed by calling <code class="docutils literal notranslate"><span class="pre">get_vehicle_state()</span></code> . It returns the following struct:</p></li>
</ol>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="k">namespace</span><span class="w"> </span><span class="nn">autopilot</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">2</span><span class="c1">// State of the vehicle</span>
<span class="linenos">3</span><span class="k">struct</span><span class="w"> </span><span class="nc">State</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">4</span><span class="w">    </span><span class="n">Eigen</span><span class="o">::</span><span class="n">Vector3d</span><span class="w"> </span><span class="n">position</span><span class="p">{</span><span class="n">Eigen</span><span class="o">::</span><span class="n">Vector3d</span><span class="o">::</span><span class="n">Zero</span><span class="p">()};</span><span class="w">           </span><span class="c1">// Position of the vehicle (FRD) in the world frame NED</span>
<span class="linenos">5</span><span class="w">    </span><span class="n">Eigen</span><span class="o">::</span><span class="n">Vector3d</span><span class="w"> </span><span class="n">velocity</span><span class="p">{</span><span class="n">Eigen</span><span class="o">::</span><span class="n">Vector3d</span><span class="o">::</span><span class="n">Zero</span><span class="p">()};</span><span class="w">           </span><span class="c1">// Velocity of the vehicle (FRD) with respect to the world frame NED expressed in the world frame NED</span>
<span class="linenos">6</span><span class="w">    </span><span class="n">Eigen</span><span class="o">::</span><span class="n">Quaterniond</span><span class="w"> </span><span class="n">attitude</span><span class="p">{</span><span class="mf">1.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">};</span><span class="w">             </span><span class="c1">// Attitude of the vehicle (FRD) with respect to the world frame NED expressed in the world frame NED</span>
<span class="linenos">7</span><span class="w">    </span><span class="n">Eigen</span><span class="o">::</span><span class="n">Vector3d</span><span class="w"> </span><span class="n">angular_velocity</span><span class="p">{</span><span class="n">Eigen</span><span class="o">::</span><span class="n">Vector3d</span><span class="o">::</span><span class="n">Zero</span><span class="p">()};</span><span class="w">   </span><span class="c1">// Angular velocity of the vehicle (FRD) with respect to the world frame NED expressed in the body frame FRD</span>
<span class="linenos">8</span><span class="p">};</span>
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li><p>The <code class="docutils literal notranslate"><span class="pre">Status</span></code> of the vehicle can be accessed by calling <code class="docutils literal notranslate"><span class="pre">get_vehicle_status()</span></code> . It returns the following struct:</p></li>
</ol>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="k">namespace</span><span class="w"> </span><span class="nn">autopilot</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">2</span><span class="c1">// Status of the vehicle</span>
<span class="linenos">3</span><span class="k">struct</span><span class="w"> </span><span class="nc">VehicleStatus</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">4</span><span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">armed</span><span class="p">{</span><span class="nb">false</span><span class="p">};</span><span class="w">      </span><span class="c1">// Whether the vehicle is armed</span>
<span class="linenos">5</span><span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">flying</span><span class="p">{</span><span class="nb">false</span><span class="p">};</span><span class="w">     </span><span class="c1">// Whether the vehicle is flying</span>
<span class="linenos">6</span><span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">offboard</span><span class="p">{</span><span class="nb">false</span><span class="p">};</span><span class="w">   </span><span class="c1">// Whether the vehicle is in offboard mode</span>
<span class="linenos">7</span><span class="p">};</span>
</pre></div>
</div>
<ol class="arabic simple" start="3">
<li><p>The <code class="docutils literal notranslate"><span class="pre">Constants</span></code> such as mass or thrust curve can be accessed by calling <code class="docutils literal notranslate"><span class="pre">get_vehicle_constants</span></code> . It returns the following struct:</p></li>
</ol>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="k">namespace</span><span class="w"> </span><span class="nn">autopilot</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">2</span><span class="c1">// Dynamical constants of the vehicle</span>
<span class="linenos">3</span><span class="k">struct</span><span class="w"> </span><span class="nc">VehicleConstants</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">4</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">id</span><span class="p">{</span><span class="mi">0</span><span class="p">};</span><span class="w">                                                                </span><span class="c1">// ID of the vehicle         </span>
<span class="linenos">5</span><span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">mass</span><span class="p">{</span><span class="mf">0.0</span><span class="p">};</span><span class="w">                                                         </span><span class="c1">// Mass of the vehicle (in Kg)</span>
<span class="linenos">6</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">thrust_curve_id</span><span class="p">{</span><span class="s">&quot;None&quot;</span><span class="p">};</span><span class="w">                                      </span><span class="c1">// Thrust curve of the vehicle</span>
<span class="linenos">7</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="w"> </span><span class="n">thurst_curve_params</span><span class="p">{</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="p">()};</span><span class="w"> </span><span class="c1">// Thrust curve parameters</span>
<span class="linenos">8</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">thrust_curve_values</span><span class="p">{</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">()};</span><span class="w">           </span><span class="c1">// Thrust curve values associated with the parameters</span>
</pre></div>
</div>
<p>This means that to access these values, you do not need to manually subscribe to the ROS 2 topics. The autopilot
takes care of that for you. However, if you are required to access other values that are not provided by the <code class="docutils literal notranslate"><span class="pre">Mode</span></code> class, or if you need to publish
values to the ROS 2 topics, you can do so by using the <code class="docutils literal notranslate"><span class="pre">node_</span></code> shared pointer that is a member of the <code class="docutils literal notranslate"><span class="pre">Mode</span></code> class.</p>
<p>4. The <code class="docutils literal notranslate"><span class="pre">Mode</span></code> class also provides a shared pointer to a <code class="docutils literal notranslate"><span class="pre">controller_</span></code> object that can be used to access the controller interface. To check
the available methods in the controller interface, please refer to the <a class="reference internal" href="controllers.html#controllers"><span class="std std-ref">Controllers</span></a> page. This is useful if you want to send control commands to the vehicle
without having to publish to the ROS 2 topics directly. The autopilot takes care of that for you.</p>
<p>5. The <code class="docutils literal notranslate"><span class="pre">Mode</span></code> class also provides a shared pointer to a <code class="docutils literal notranslate"><span class="pre">trajectory_manager_</span></code> object that can be used to access the trajectory manager interface. To check
the available methods in the trajectory manager interface, please refer to the <a class="reference internal" href="trajectory_manager.html#trajectory-manager"><span class="std std-ref">Trajectory Manager</span></a> page. This is useful if your mode needs to follow a trajectory
and you don’t want to manually subscribe to the ROS 2 topics or hard-code the trajectory in the mode.</p>
</section>
<section id="provided-state-machine-modes">
<h2>1. Provided State Machine Modes<a class="headerlink" href="#provided-state-machine-modes" title="Permalink to this heading"></a></h2>
<p>The autopilot provides the following operating modes:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">Arm</span></code> - The vehicle is armed and ready to take off.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Disarm</span></code> - The vehicle is on the ground and disarmed.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Takeoff</span></code> - The vehicle takes of to a predefined altitude above the current position.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Land</span></code> - The vehicle lands at the current position.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Hold</span></code> - The vehicle holds its current position.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Follow</span> <span class="pre">Trajectory</span></code> - The vehicle follows the trajectory loaded in the trajectory manager.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Waypoint</span></code> - The vehicle goes to a waypoint.</p></li>
</ul>
<p>Since the autopilot modes are implemented as plugins, they are loaded at runtime by the autopilot. The autopilot uses the <code class="docutils literal notranslate"><span class="pre">pluginlib</span></code> package to load the plugins.
This also allows for the modes to be implemented in different packages, which is useful if you want to keep the autopilot package clean and modular.</p>
<p>For instance, if you want to check the implementation of the provided base modes, you can find them in the <code class="docutils literal notranslate"><span class="pre">pegasus_autopilot/autopilot_modes</span></code> package.</p>
</section>
<section id="adding-custom-modes-to-the-state-machine">
<h2>2. Adding Custom Modes to the State Machine<a class="headerlink" href="#adding-custom-modes-to-the-state-machine" title="Permalink to this heading"></a></h2>
<p>In this section we will implement a custom waypoint operating mode. In this mode, we will subscribe to a ROS 2 topic that publishes the desired waypoint
and drive the vehicle to that waypoint. This is a simple example to show how to implement a custom operating mode. You can implement more complex modes
by following the same steps.</p>
<ol class="arabic simple">
<li><p>Start by creating a new ROS 2 package inside your workspace, where you will implement the custom operating mode.</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Go to the src directory of your workspace</span>
<span class="nb">cd</span><span class="w"> </span>~/pegasus/src

<span class="c1"># Create a C++ ROS 2 package where you are going to implement the custom modes</span>
ros2<span class="w"> </span>pkg<span class="w"> </span>create<span class="w"> </span>--build-type<span class="w"> </span>ament_cmake<span class="w"> </span>custom_modes

<span class="c1"># Go inside the package directory</span>
<span class="nb">cd</span><span class="w"> </span>custom_modes

<span class="c1"># Create a xml file where you are going to define your custom mode as a plugin</span>
touch<span class="w"> </span>custom_modes_plugins.xml
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li><p>Inside the <code class="docutils literal notranslate"><span class="pre">include/custom_modes</span></code> directory, create a new header file named <code class="docutils literal notranslate"><span class="pre">mode_custom_waypoint.hpp</span></code>.</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create a new header file inside the include directory of the custom_modes package</span>
touch<span class="w"> </span>include/custom_modes/mode_custom_waypoint.hpp
</pre></div>
</div>
<p>This file will contain the definition of the custom operating mode that drives the vehicle to a pre-defined waypoint. Your operation mode
must inherit from the <code class="docutils literal notranslate"><span class="pre">autopilot::Mode</span></code> class and implement the following methods: <code class="docutils literal notranslate"><span class="pre">initialize</span></code>, <code class="docutils literal notranslate"><span class="pre">enter</span></code>, <code class="docutils literal notranslate"><span class="pre">exit</span></code> and <code class="docutils literal notranslate"><span class="pre">update</span></code>.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#pragma once</span>
<span class="linenos"> 2</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;Eigen/Core&gt;</span>
<span class="hll"><span class="linenos"> 3</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;autopilot/mode.hpp&gt;</span>
</span><span class="linenos"> 4</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;pegasus_msgs/msg/control_position.hpp&quot;</span>
<span class="linenos"> 5</span>
<span class="linenos"> 6</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;rclcpp/rclcpp.hpp&quot;</span>
<span class="linenos"> 7</span>
<span class="linenos"> 8</span><span class="k">namespace</span><span class="w"> </span><span class="nn">autopilot</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 9</span>
<span class="hll"><span class="linenos">10</span><span class="k">class</span><span class="w"> </span><span class="nc">CustomWaypointMode</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">autopilot</span><span class="o">::</span><span class="n">Mode</span><span class="w"> </span><span class="p">{</span>
</span><span class="linenos">11</span>
<span class="linenos">12</span><span class="k">public</span><span class="o">:</span>
<span class="linenos">13</span>
<span class="hll"><span class="linenos">14</span><span class="w">   </span><span class="o">~</span><span class="n">CustomWaypointMode</span><span class="p">();</span>
</span><span class="hll"><span class="linenos">15</span><span class="w">   </span><span class="kt">void</span><span class="w"> </span><span class="nf">initialize</span><span class="p">()</span><span class="w"> </span><span class="k">override</span><span class="p">;</span>
</span><span class="hll"><span class="linenos">16</span><span class="w">   </span><span class="kt">bool</span><span class="w"> </span><span class="nf">enter</span><span class="p">()</span><span class="w"> </span><span class="k">override</span><span class="p">;</span>
</span><span class="hll"><span class="linenos">17</span><span class="w">   </span><span class="kt">bool</span><span class="w"> </span><span class="nf">exit</span><span class="p">()</span><span class="w"> </span><span class="k">override</span><span class="p">;</span>
</span><span class="hll"><span class="linenos">18</span><span class="w">   </span><span class="kt">void</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">dt</span><span class="p">)</span><span class="w"> </span><span class="k">override</span><span class="p">;</span>
</span><span class="linenos">19</span>
<span class="linenos">20</span><span class="k">protected</span><span class="o">:</span>
<span class="linenos">21</span>
<span class="linenos">22</span><span class="w">   </span><span class="c1">// ROS 2 subscriber for the waypoint topic</span>
<span class="linenos">23</span><span class="w">   </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">Subscription</span><span class="o">&lt;</span><span class="n">pegasus_msgs</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">ControlPosition</span><span class="o">&gt;::</span><span class="n">SharedPtr</span><span class="w"> </span><span class="n">waypoint_subscriber_</span><span class="p">;</span>
<span class="linenos">24</span>
<span class="linenos">25</span><span class="w">   </span><span class="c1">// Callback for the waypoint subscriber</span>
<span class="linenos">26</span><span class="w">   </span><span class="kt">void</span><span class="w"> </span><span class="nf">waypoint_callback</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">pegasus_msgs</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">ControlPosition</span><span class="o">::</span><span class="n">ConstSharedPtr</span><span class="w"> </span><span class="n">msg</span><span class="p">);</span>
<span class="linenos">27</span>
<span class="linenos">28</span><span class="w">   </span><span class="c1">// Stores the latest target position and attitude waypoint to be at</span>
<span class="linenos">29</span><span class="w">   </span><span class="n">Eigen</span><span class="o">::</span><span class="n">Vector3d</span><span class="w"> </span><span class="n">target_pos</span><span class="p">{</span><span class="mf">1.0</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">,</span><span class="w"> </span><span class="mf">-1.5</span><span class="p">};</span>
<span class="linenos">30</span><span class="w">   </span><span class="kt">float</span><span class="w"> </span><span class="n">target_yaw</span><span class="p">{</span><span class="mf">0.0f</span><span class="p">};</span>
<span class="linenos">31</span><span class="w">   </span><span class="kt">bool</span><span class="w"> </span><span class="n">waypoint_set_</span><span class="p">{</span><span class="nb">false</span><span class="p">};</span>
<span class="linenos">32</span><span class="p">};</span>
<span class="linenos">33</span><span class="p">}</span>
</pre></div>
</div>
<ul class="simple">
<li><p>The <code class="docutils literal notranslate"><span class="pre">initialize</span></code> is called by the autopilot when it is loading all the operating modes into memory. This is where you should initialize the ROS 2 publishers, subscribers and services if needed.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">enter</span></code> is called by the autopilot when the mode is about to be entered. This is where you should check if the mode can be entered and set the necessary flags. If the mode cannot be entered, return false, and the autopilot will not enter this mode and will keep the current operation mode.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">exit</span></code> is called by the autopilot when the mode is about to be exited. This is where you should reset the flags and clean up any resources that were allocated.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">update</span></code> is called by the autopilot at every iteration of the control loop. This is where you should implement the logic of the mode.</p></li>
</ul>
<ol class="arabic simple" start="3">
<li><p>Inside the <code class="docutils literal notranslate"><span class="pre">src</span></code> directory, create a new source file named <code class="docutils literal notranslate"><span class="pre">mode_custom_waypoint.cpp</span></code>.</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Go to the src directory of the custom_modes package</span>
touch<span class="w"> </span>src/mode_custom_waypoint.cpp
</pre></div>
</div>
<p>This file will contain the implementation of the custom operating mode that drives the vehicle to a given waypoint.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="hll"><span class="linenos"> 1</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;custom_modes/mode_custom_waypoint.hpp&quot;</span>
</span><span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="k">namespace</span><span class="w"> </span><span class="nn">autopilot</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 4</span>
<span class="linenos"> 5</span><span class="n">CustomWaypointMode</span><span class="o">::~</span><span class="n">CustomWaypointMode</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 6</span><span class="w">   </span><span class="c1">// Terminate the waypoint subscriber</span>
<span class="linenos"> 7</span><span class="w">   </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">waypoint_subscriber_</span><span class="p">.</span><span class="n">reset</span><span class="p">();</span>
<span class="linenos"> 8</span><span class="p">}</span>
<span class="linenos"> 9</span>
<span class="hll"><span class="linenos">10</span><span class="c1">// This method is called when the autopilot loads all the modes into memory</span>
</span><span class="hll"><span class="linenos">11</span><span class="kt">void</span><span class="w"> </span><span class="n">CustomWaypointMode</span><span class="o">::</span><span class="n">initialize</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span class="linenos">12</span>
<span class="linenos">13</span><span class="w">   </span><span class="c1">// Get the name of the topic where the waypoint is published from the ROS 2 parameter server</span>
<span class="linenos">14</span><span class="w">   </span><span class="n">node_</span><span class="o">-&gt;</span><span class="n">declare_parameter</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&quot;autopilot.CustomWaypointMode.waypoint_topic&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;waypoint&quot;</span><span class="p">);</span>
<span class="linenos">15</span>
<span class="linenos">16</span><span class="w">   </span><span class="c1">// Create a subscriber to the waypoint topic (to get the desired waypoint to track)</span>
<span class="linenos">17</span><span class="w">   </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">waypoint_subscriber_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">node_</span><span class="o">-&gt;</span><span class="n">create_subscription</span><span class="o">&lt;</span><span class="n">pegasus_msgs</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">ControlPosition</span><span class="o">&gt;</span><span class="p">(</span>
<span class="linenos">18</span><span class="w">      </span><span class="n">node_</span><span class="o">-&gt;</span><span class="n">get_parameter</span><span class="p">(</span><span class="s">&quot;autopilot.CustomWaypointMode.waypoint_topic&quot;</span><span class="p">).</span><span class="n">as_string</span><span class="p">(),</span>
<span class="linenos">19</span><span class="w">      </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">SystemDefaultsQoS</span><span class="p">(),</span>
<span class="linenos">20</span><span class="w">      </span><span class="n">std</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">CustomWaypointMode</span><span class="o">::</span><span class="n">waypoint_callback</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">placeholders</span><span class="o">::</span><span class="n">_1</span><span class="p">));</span>
<span class="linenos">21</span>
<span class="linenos">22</span><span class="w">   </span><span class="c1">// Log that the waypoint mode has been initialized correctly</span>
<span class="linenos">23</span><span class="w">   </span><span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">node_</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;CustomWaypointMode initialized&quot;</span><span class="p">);</span>
<span class="linenos">24</span><span class="p">}</span>
<span class="linenos">25</span>
<span class="hll"><span class="linenos">26</span><span class="c1">// This method is called when the autopilot is about to enter the waypoint mode</span>
</span><span class="hll"><span class="linenos">27</span><span class="kt">bool</span><span class="w"> </span><span class="n">CustomWaypointMode</span><span class="o">::</span><span class="n">enter</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span class="linenos">28</span>
<span class="linenos">29</span><span class="w">   </span><span class="c1">// Check if the waypoint was already set - if not, then do not enter the waypoint mode</span>
<span class="linenos">30</span><span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">waypoint_set_</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">31</span><span class="w">      </span><span class="n">RCLCPP_ERROR</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">node_</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;Waypoint not set - cannot enter waypoint mode.&quot;</span><span class="p">);</span>
<span class="linenos">32</span><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="linenos">33</span><span class="w">   </span><span class="p">}</span>
<span class="linenos">34</span>
<span class="linenos">35</span><span class="w">   </span><span class="c1">// Reset the waypoint flag (to make sure we do not enter twice in this mode without setting a new waypoint)</span>
<span class="linenos">36</span><span class="w">   </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">waypoint_set_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="linenos">37</span>
<span class="linenos">38</span><span class="w">   </span><span class="c1">// Return true to indicate that the mode has been entered successfully</span>
<span class="linenos">39</span><span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="linenos">40</span><span class="p">}</span>
<span class="linenos">41</span>
<span class="hll"><span class="linenos">42</span><span class="c1">// This method is called when the autopilot is about to exit the waypoint mode and enter another mode</span>
</span><span class="hll"><span class="linenos">43</span><span class="kt">bool</span><span class="w"> </span><span class="n">CustomWaypointMode</span><span class="o">::</span><span class="n">exit</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span class="linenos">44</span>
<span class="linenos">45</span><span class="w">   </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">waypoint_set_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="linenos">46</span>
<span class="linenos">47</span><span class="w">   </span><span class="c1">// Nothing to do here</span>
<span class="linenos">48</span><span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w">   </span><span class="c1">// Return true to indicate that the mode has been exited successfully</span>
<span class="linenos">49</span><span class="p">}</span>
<span class="linenos">50</span>
<span class="hll"><span class="linenos">51</span><span class="c1">// This method is called at every iteration of the control loop by the autopilot</span>
</span><span class="hll"><span class="linenos">52</span><span class="kt">void</span><span class="w"> </span><span class="n">CustomWaypointMode</span><span class="o">::</span><span class="n">update</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">dt</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span class="linenos">53</span>
<span class="linenos">54</span><span class="w">   </span><span class="c1">// Set the controller to track the target position and attitude</span>
<span class="linenos">55</span><span class="w">   </span><span class="c1">// In this case we do not which to implement a low-level controller, so we will use the set_position method from the controller interface</span>
<span class="linenos">56</span><span class="w">   </span><span class="c1">// and use whatever controller is currently active in the autopilot.</span>
<span class="linenos">57</span><span class="w">   </span><span class="c1">// Note: we could also have a custom implementation here and send lower level controls using the controller interface</span>
<span class="linenos">58</span><span class="w">   </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">controller_</span><span class="o">-&gt;</span><span class="n">set_position</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">target_pos</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">target_yaw</span><span class="p">,</span><span class="w"> </span><span class="n">dt</span><span class="p">);</span>
<span class="linenos">59</span><span class="p">}</span>
<span class="linenos">60</span>
<span class="hll"><span class="linenos">61</span><span class="c1">// ROS 2 callback for the waypoint subscriber - this is called whenever a new waypoint is published</span>
</span><span class="hll"><span class="linenos">62</span><span class="kt">void</span><span class="w"> </span><span class="n">CustomWaypointMode</span><span class="o">::</span><span class="n">waypoint_callback</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">pegasus_msgs</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">ControlPosition</span><span class="o">::</span><span class="n">ConstSharedPtr</span><span class="w"> </span><span class="n">msg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span class="linenos">63</span>
<span class="linenos">64</span><span class="w">   </span><span class="c1">// Set the waypoint</span>
<span class="linenos">65</span><span class="w">   </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">target_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">position</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="linenos">66</span><span class="w">   </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">target_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">position</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="linenos">67</span><span class="w">   </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">target_pos</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">position</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="linenos">68</span><span class="w">   </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">target_yaw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">yaw</span><span class="p">;</span>
<span class="linenos">69</span>
<span class="linenos">70</span><span class="w">   </span><span class="c1">// Set the waypoint flag</span>
<span class="linenos">71</span><span class="w">   </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">waypoint_set_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="linenos">72</span>
<span class="linenos">73</span><span class="w">   </span><span class="c1">// Log that the waypoint has been set successfully</span>
<span class="linenos">74</span><span class="w">   </span><span class="n">RCLCPP_WARN</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">node_</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;Waypoint set to (%f, %f, %f) with yaw %f&quot;</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">target_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">target_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">target_pos</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">target_yaw</span><span class="p">);</span>
<span class="linenos">75</span><span class="p">}</span>
<span class="linenos">76</span>
<span class="linenos">77</span><span class="p">}</span><span class="w"> </span><span class="c1">// namespace autopilot</span>
<span class="linenos">78</span>
<span class="hll"><span class="linenos">79</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;pluginlib/class_list_macros.hpp&gt;</span>
</span><span class="hll"><span class="linenos">80</span><span class="n">PLUGINLIB_EXPORT_CLASS</span><span class="p">(</span><span class="n">autopilot</span><span class="o">::</span><span class="n">CustomWaypointMode</span><span class="p">,</span><span class="w"> </span><span class="n">autopilot</span><span class="o">::</span><span class="n">Mode</span><span class="p">)</span>
</span></pre></div>
</div>
<p>The last 2 lines of the code snippet above are necessary to export the custom mode as a plugin. The <code class="docutils literal notranslate"><span class="pre">pluginlib</span></code> package uses these lines to load the plugin at runtime.</p>
<p>4. Modify the <code class="docutils literal notranslate"><span class="pre">package.xml</span></code> file to include the following dependencies <code class="docutils literal notranslate"><span class="pre">autopilot</span></code> and <code class="docutils literal notranslate"><span class="pre">pluginlib</span></code>, according to the code snippet below.
Additionally, we also need to include the <code class="docutils literal notranslate"><span class="pre">pegasus_msgs</span></code> package as a dependency, since we are subscribing to a ROS 2 topic that publishes messages from this package.</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">&lt;?xml version=&quot;1.0&quot;?&gt;</span>
<span class="linenos"> 2</span><span class="cp">&lt;?xml-model href=&quot;http://download.ros.org/schema/package_format3.xsd&quot; schematypens=&quot;http://www.w3.org/2001/XMLSchema&quot;?&gt;</span>
<span class="linenos"> 3</span><span class="nt">&lt;package</span><span class="w"> </span><span class="na">format=</span><span class="s">&quot;3&quot;</span><span class="nt">&gt;</span>
<span class="hll"><span class="linenos"> 4</span><span class="w">   </span><span class="nt">&lt;name&gt;</span>custom_modes<span class="nt">&lt;/name&gt;</span>
</span><span class="hll"><span class="linenos"> 5</span><span class="w">   </span><span class="nt">&lt;version&gt;</span>1.0.0<span class="nt">&lt;/version&gt;</span>
</span><span class="hll"><span class="linenos"> 6</span><span class="w">   </span><span class="nt">&lt;description&gt;&lt;/description&gt;</span>
</span><span class="hll"><span class="linenos"> 7</span><span class="w">   </span><span class="nt">&lt;author</span><span class="w"> </span><span class="na">email=</span><span class="s">&quot;your.email@tecnico.ulisboa.pt&quot;</span><span class="nt">&gt;</span>Author<span class="w"> </span>Name<span class="nt">&lt;/author&gt;</span>
</span><span class="hll"><span class="linenos"> 8</span><span class="w">   </span><span class="nt">&lt;license&gt;</span>BSD-3<span class="nt">&lt;/license&gt;</span>
</span><span class="linenos"> 9</span>
<span class="linenos">10</span><span class="w">   </span><span class="nt">&lt;buildtool_depend&gt;</span>ament_cmake_ros<span class="nt">&lt;/buildtool_depend&gt;</span>
<span class="linenos">11</span>
<span class="hll"><span class="linenos">12</span><span class="w">   </span><span class="nt">&lt;depend&gt;</span>autopilot<span class="nt">&lt;/depend&gt;</span>
</span><span class="hll"><span class="linenos">13</span><span class="w">   </span><span class="nt">&lt;depend&gt;</span>pluginlib<span class="nt">&lt;/depend&gt;</span>
</span><span class="hll"><span class="linenos">14</span><span class="w">   </span><span class="nt">&lt;depend&gt;</span>pegasus_msgs<span class="nt">&lt;/depend&gt;</span>
</span><span class="linenos">15</span>
<span class="linenos">16</span><span class="w">   </span><span class="nt">&lt;test_depend&gt;</span>ament_lint_auto<span class="nt">&lt;/test_depend&gt;</span>
<span class="linenos">17</span><span class="w">   </span><span class="nt">&lt;test_depend&gt;</span>ament_lint_common<span class="nt">&lt;/test_depend&gt;</span>
<span class="linenos">18</span>
<span class="linenos">19</span><span class="w">   </span><span class="nt">&lt;export&gt;</span>
<span class="linenos">20</span><span class="w">      </span><span class="nt">&lt;build_type&gt;</span>ament_cmake<span class="nt">&lt;/build_type&gt;</span>
<span class="linenos">21</span><span class="w">   </span><span class="nt">&lt;/export&gt;</span>
<span class="linenos">22</span><span class="nt">&lt;/package&gt;</span>
</pre></div>
</div>
<ol class="arabic simple" start="5">
<li><p>Also modify the <code class="docutils literal notranslate"><span class="pre">CMakeLists.txt</span></code> file to include the following dependencies <code class="docutils literal notranslate"><span class="pre">autopilot</span></code>, <code class="docutils literal notranslate"><span class="pre">pegasus_msgs</span></code> and <code class="docutils literal notranslate"><span class="pre">pluginlib</span></code>, according to the code snippet below. Additionally, we need to include the <code class="docutils literal notranslate"><span class="pre">Eigen3</span></code> package as a dependency, since we are using Eigen for linear algebra operations.</p></li>
</ol>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="nb">cmake_minimum_required</span><span class="p">(</span><span class="s">VERSION</span><span class="w"> </span><span class="s">3.8</span><span class="p">)</span>
<span class="linenos"> 2</span><span class="nb">project</span><span class="p">(</span><span class="s">custom_modes</span><span class="p">)</span>
<span class="linenos"> 3</span>
<span class="linenos"> 4</span><span class="c"># Default to C++20 and compiler flags to give all warnings</span>
<span class="linenos"> 5</span><span class="nb">set</span><span class="p">(</span><span class="s">CMAKE_CXX_STANDARD</span><span class="w"> </span><span class="s">20</span><span class="p">)</span>
<span class="linenos"> 6</span><span class="nb">set</span><span class="p">(</span><span class="s">CMAKE_CXX_STANDARD_REQUIRED</span><span class="w"> </span><span class="s">ON</span><span class="p">)</span>
<span class="linenos"> 7</span>
<span class="linenos"> 8</span><span class="nb">if</span><span class="p">(</span><span class="s">CMAKE_COMPILER_IS_GNUCXX</span><span class="w"> </span><span class="s">OR</span><span class="w"> </span><span class="s">CMAKE_CXX_COMPILER_ID</span><span class="w"> </span><span class="s">MATCHES</span><span class="w"> </span><span class="s2">&quot;Clang&quot;</span><span class="p">)</span>
<span class="hll"><span class="linenos"> 9</span><span class="nb">add_compile_options</span><span class="p">(</span><span class="s">-Wall</span><span class="w"> </span><span class="s">-Wextra</span><span class="w"> </span><span class="s">-Wpedantic</span><span class="w"> </span><span class="s">-Wno-unused-parameter</span><span class="w"> </span><span class="s">-Wno-sign-compare</span><span class="w"> </span><span class="s">-O3</span><span class="p">)</span>
</span><span class="linenos">10</span><span class="nb">endif</span><span class="p">()</span>
<span class="linenos">11</span>
<span class="linenos">12</span><span class="c"># find dependencies</span>
<span class="hll"><span class="linenos">13</span><span class="nb">find_package</span><span class="p">(</span><span class="s">ament_cmake</span><span class="w"> </span><span class="s">REQUIRED</span><span class="p">)</span>
</span><span class="hll"><span class="linenos">14</span><span class="nb">find_package</span><span class="p">(</span><span class="s">autopilot</span><span class="w"> </span><span class="s">REQUIRED</span><span class="p">)</span>
</span><span class="hll"><span class="linenos">15</span><span class="nb">find_package</span><span class="p">(</span><span class="s">pluginlib</span><span class="w"> </span><span class="s">REQUIRED</span><span class="p">)</span>
</span><span class="hll"><span class="linenos">16</span><span class="nb">find_package</span><span class="p">(</span><span class="s">pegasus_msgs</span><span class="w"> </span><span class="s">REQUIRED</span><span class="p">)</span>
</span><span class="hll"><span class="linenos">17</span><span class="nb">find_package</span><span class="p">(</span><span class="s">Eigen3</span><span class="w"> </span><span class="s">REQUIRED</span><span class="p">)</span>
</span><span class="linenos">18</span>
<span class="hll"><span class="linenos">19</span><span class="nb">add_library</span><span class="p">(</span><span class="o">${</span><span class="nv">PROJECT_NAME</span><span class="o">}</span>
</span><span class="hll"><span class="linenos">20</span><span class="w">   </span><span class="s">src/mode_custom_waypoint.cpp</span>
</span><span class="hll"><span class="linenos">21</span><span class="p">)</span>
</span><span class="linenos">22</span>
<span class="linenos">23</span><span class="nb">target_include_directories</span><span class="p">(</span><span class="o">${</span><span class="nv">PROJECT_NAME</span><span class="o">}</span><span class="w"> </span><span class="s">PUBLIC</span>
<span class="linenos">24</span><span class="w">   </span><span class="o">$&lt;</span><span class="nv">BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/include</span><span class="o">&gt;</span>
<span class="linenos">25</span><span class="w">   </span><span class="o">$&lt;</span><span class="nv">INSTALL_INTERFACE:include</span><span class="o">&gt;</span>
<span class="linenos">26</span><span class="w">   </span><span class="o">${</span><span class="nv">EIGEN3_INCLUDE_DIRS</span><span class="o">}</span>
<span class="linenos">27</span><span class="p">)</span>
<span class="linenos">28</span>
<span class="linenos">29</span><span class="nb">add_definitions</span><span class="p">(</span><span class="o">${</span><span class="nv">EIGEN3_DEFINITIONS</span><span class="o">}</span><span class="p">)</span>
<span class="linenos">30</span>
<span class="hll"><span class="linenos">31</span><span class="nb">set</span><span class="p">(</span><span class="s">dependencies</span>
</span><span class="hll"><span class="linenos">32</span><span class="w">   </span><span class="s">autopilot</span>
</span><span class="hll"><span class="linenos">33</span><span class="w">   </span><span class="s">pluginlib</span>
</span><span class="hll"><span class="linenos">34</span><span class="w">   </span><span class="s">pegasus_msgs</span>
</span><span class="hll"><span class="linenos">35</span><span class="p">)</span>
</span><span class="linenos">36</span>
<span class="linenos">37</span><span class="nb">ament_target_dependencies</span><span class="p">(</span><span class="o">${</span><span class="nv">PROJECT_NAME</span><span class="o">}</span><span class="w"> </span><span class="o">${</span><span class="nv">dependencies</span><span class="o">}</span><span class="p">)</span>
<span class="linenos">38</span>
<span class="hll"><span class="linenos">39</span><span class="c"># Export the pluginlib description (package containing the base class and the derived classes information in XML format)</span>
</span><span class="hll"><span class="linenos">40</span><span class="nb">pluginlib_export_plugin_description_file</span><span class="p">(</span><span class="s">autopilot</span><span class="w"> </span><span class="s">custom_modes_plugins.xml</span><span class="p">)</span>
</span><span class="linenos">41</span>
<span class="linenos">42</span><span class="nb">install</span><span class="p">(</span>
<span class="linenos">43</span><span class="w">   </span><span class="s">TARGETS</span><span class="w"> </span><span class="o">${</span><span class="nv">PROJECT_NAME</span><span class="o">}</span>
<span class="linenos">44</span><span class="w">   </span><span class="s">EXPORT</span><span class="w"> </span><span class="s">export_</span><span class="o">${</span><span class="nv">PROJECT_NAME</span><span class="o">}</span>
<span class="linenos">45</span><span class="w">   </span><span class="s">ARCHIVE</span><span class="w"> </span><span class="s">DESTINATION</span><span class="w"> </span><span class="s">lib</span>
<span class="linenos">46</span><span class="w">   </span><span class="s">LIBRARY</span><span class="w"> </span><span class="s">DESTINATION</span><span class="w"> </span><span class="s">lib</span>
<span class="linenos">47</span><span class="w">   </span><span class="s">RUNTIME</span><span class="w"> </span><span class="s">DESTINATION</span><span class="w"> </span><span class="s">bin</span>
<span class="linenos">48</span><span class="p">)</span>
<span class="linenos">49</span>
<span class="hll"><span class="linenos">50</span><span class="c"># Causes the visibility macros to use dllexport rather than dllimport,</span>
</span><span class="hll"><span class="linenos">51</span><span class="c"># which is appropriate when building the dll but not consuming it.</span>
</span><span class="hll"><span class="linenos">52</span><span class="nb">target_compile_definitions</span><span class="p">(</span><span class="o">${</span><span class="nv">PROJECT_NAME</span><span class="o">}</span><span class="w"> </span><span class="s">PRIVATE</span><span class="w"> </span><span class="s2">&quot;CUSTOM_MODES_BUILDING_LIBRARY&quot;</span><span class="p">)</span>
</span><span class="linenos">53</span>
<span class="linenos">54</span><span class="nb">install</span><span class="p">(</span>
<span class="linenos">55</span><span class="w">   </span><span class="s">DIRECTORY</span><span class="w"> </span><span class="s">include/</span>
<span class="linenos">56</span><span class="w">   </span><span class="s">DESTINATION</span><span class="w"> </span><span class="s">include</span>
<span class="linenos">57</span><span class="p">)</span>
<span class="linenos">58</span>
<span class="linenos">59</span><span class="nb">if</span><span class="p">(</span><span class="s">BUILD_TESTING</span><span class="p">)</span>
<span class="linenos">60</span><span class="nb">find_package</span><span class="p">(</span><span class="s">ament_lint_auto</span><span class="w"> </span><span class="s">REQUIRED</span><span class="p">)</span>
<span class="linenos">61</span><span class="c"># the following line skips the linter which checks for copyrights</span>
<span class="linenos">62</span><span class="c"># comment the line when a copyright and license is added to all source files</span>
<span class="linenos">63</span><span class="nb">set</span><span class="p">(</span><span class="s">ament_cmake_copyright_FOUND</span><span class="w"> </span><span class="s">TRUE</span><span class="p">)</span>
<span class="linenos">64</span><span class="c"># the following line skips cpplint (only works in a git repo)</span>
<span class="linenos">65</span><span class="c"># comment the line when this package is in a git repo and when</span>
<span class="linenos">66</span><span class="c"># a copyright and license is added to all source files</span>
<span class="linenos">67</span><span class="nb">set</span><span class="p">(</span><span class="s">ament_cmake_cpplint_FOUND</span><span class="w"> </span><span class="s">TRUE</span><span class="p">)</span>
<span class="linenos">68</span><span class="nb">ament_lint_auto_find_test_dependencies</span><span class="p">()</span>
<span class="linenos">69</span><span class="nb">endif</span><span class="p">()</span>
<span class="linenos">70</span>
<span class="linenos">71</span><span class="nb">ament_export_include_directories</span><span class="p">(</span><span class="s">include</span><span class="p">)</span>
<span class="linenos">72</span><span class="nb">ament_export_libraries</span><span class="p">(</span><span class="o">${</span><span class="nv">PROJECT_NAME</span><span class="o">}</span><span class="p">)</span>
<span class="linenos">73</span><span class="nb">ament_export_dependencies</span><span class="p">(</span><span class="o">${</span><span class="nv">dependencies</span><span class="o">}</span><span class="p">)</span>
<span class="linenos">74</span><span class="nb">ament_export_targets</span><span class="p">(</span><span class="s">export_</span><span class="o">${</span><span class="nv">PROJECT_NAME</span><span class="o">}</span><span class="p">)</span>
<span class="linenos">75</span><span class="nb">ament_package</span><span class="p">()</span>
</pre></div>
</div>
<ol class="arabic simple" start="6">
<li><p>Create a xml file named <code class="docutils literal notranslate"><span class="pre">custom_modes_plugins.xml</span></code> inside the package directory. This file will contain the definition of the custom mode as a plugin.</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create a xml file inside the package directory</span>
touch<span class="w"> </span>custom_modes_plugins.xml
</pre></div>
</div>
<p>The content of the <code class="docutils literal notranslate"><span class="pre">custom_modes_plugins.xml</span></code> file should be as follows:</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="nt">&lt;library</span><span class="w"> </span><span class="na">path=</span><span class="s">&quot;custom_modes&quot;</span><span class="nt">&gt;</span>
<span class="linenos">2</span><span class="w">   </span><span class="nt">&lt;class</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;autopilot::CustomWaypointMode&quot;</span><span class="w"> </span><span class="na">base_class_type=</span><span class="s">&quot;autopilot::Mode&quot;</span><span class="nt">&gt;</span>
<span class="linenos">3</span><span class="w">      </span><span class="nt">&lt;description&gt;</span>A<span class="w"> </span>custom<span class="w"> </span>waypoint<span class="w"> </span>mode<span class="w"> </span>that<span class="w"> </span>drives<span class="w"> </span>the<span class="w"> </span>vehicle<span class="w"> </span>to<span class="w"> </span>a<span class="w"> </span>given<span class="w"> </span>waypoint.<span class="nt">&lt;/description&gt;</span>
<span class="linenos">4</span><span class="w">   </span><span class="nt">&lt;/class&gt;</span>
<span class="linenos">5</span><span class="nt">&lt;/library&gt;</span>
</pre></div>
</div>
<p>7. Create a configuration file named <code class="docutils literal notranslate"><span class="pre">custom_modes.yaml</span></code> inside the package directory. This file will contain the configuration parameters for launching the autopilot
with the custom mode.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create a yaml file inside the package directory</span>
touch<span class="w"> </span>config/custom_modes.yaml
</pre></div>
</div>
<p>The content of the <code class="docutils literal notranslate"><span class="pre">custom_modes.yaml</span></code> file should be as follows. In line 8, we define the modes that will be loaded by the autopilot. In this case, we are adding the custom waypoint mode to the list of modes.</p>
<p>Lines 23-26 define the configuration parameters for each mode, including the newly created custom waypoint mode. In this case, we are defining the topic where the waypoint is published.</p>
<p>We also define the valid_transitions, which define which modes are allowed to transition to from the custom waypoint mode. In this case, the custom waypoint mode can transition to the <code class="docutils literal notranslate"><span class="pre">Hold</span></code> and <code class="docutils literal notranslate"><span class="pre">Land</span></code> modes.
Moreover we define the fallback mode, which is the mode that the autopilot will transition to if the custom waypoint mode is not able to execute its logic.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="nt">/**</span><span class="p">:</span>
<span class="linenos"> 2</span><span class="nt">ros__parameters</span><span class="p">:</span>
<span class="linenos"> 3</span><span class="w">   </span><span class="nt">autopilot</span><span class="p">:</span>
<span class="linenos"> 4</span><span class="w">      </span><span class="c1"># Update rate</span>
<span class="linenos"> 5</span><span class="w">      </span><span class="nt">rate</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">50.0</span><span class="w"> </span><span class="c1"># Hz</span>
<span class="linenos"> 6</span><span class="w">      </span><span class="nt">default_mode</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;DisarmMode&quot;</span>
<span class="linenos"> 7</span><span class="w">      </span><span class="c1"># Define all the existing operation modes</span>
<span class="hll"><span class="linenos"> 8</span><span class="w">      </span><span class="nt">modes</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;DisarmMode&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;ArmMode&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;LandMode&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;HoldMode&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;CustomWaypointMode&quot;</span><span class="p p-Indicator">]</span>
</span><span class="linenos"> 9</span><span class="w">      </span><span class="c1"># Configurations of each operating mode:</span>
<span class="linenos">10</span><span class="w">      </span><span class="nt">DisarmMode</span><span class="p">:</span>
<span class="linenos">11</span><span class="w">         </span><span class="nt">valid_transitions</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;ArmMode&quot;</span><span class="p p-Indicator">]</span>
<span class="linenos">12</span><span class="w">         </span><span class="nt">fallback</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;DisarmMode&quot;</span>
<span class="linenos">13</span><span class="w">         </span><span class="nt">disarm_service</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;fmu/kill_switch&quot;</span>
<span class="linenos">14</span><span class="w">      </span><span class="nt">ArmMode</span><span class="p">:</span>
<span class="linenos">15</span><span class="w">         </span><span class="nt">valid_transitions</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;DisarmMode&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;CustomWaypointMode&quot;</span><span class="p p-Indicator">]</span>
<span class="linenos">16</span><span class="w">         </span><span class="nt">fallback</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;DisarmMode&quot;</span>
<span class="linenos">17</span><span class="w">         </span><span class="nt">geofencing_violation_fallback</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;DisarmMode&quot;</span>
<span class="linenos">18</span><span class="w">         </span><span class="nt">arm_service</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;fmu/arm&quot;</span>
<span class="linenos">19</span><span class="w">         </span><span class="nt">offboard_service</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;fmu/offboard&quot;</span>
<span class="linenos">20</span><span class="w">      </span><span class="nt">HoldMode</span><span class="p">:</span>
<span class="linenos">21</span><span class="w">         </span><span class="nt">valid_transitions</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;LandMode&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;CustomWaypointMode&quot;</span><span class="p p-Indicator">]</span>
<span class="linenos">22</span><span class="w">         </span><span class="nt">fallback</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;LandMode&quot;</span>
<span class="hll"><span class="linenos">23</span><span class="w">      </span><span class="nt">LandMode</span><span class="p">:</span>
</span><span class="hll"><span class="linenos">24</span><span class="w">         </span><span class="nt">valid_transitions</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;DisarmMode&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;ArmMode&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;TakeoffMode&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;HoldMode&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;WaypointMode&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;FollowTrajectoryMode&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;PassThroughMode&quot;</span><span class="p p-Indicator">]</span>
</span><span class="hll"><span class="linenos">25</span><span class="w">         </span><span class="nt">fallback</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;HoldMode&quot;</span>
</span><span class="hll"><span class="linenos">26</span><span class="w">         </span><span class="nt">on_finish</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;DisarmMode&quot;</span>
</span><span class="linenos">27</span><span class="w">         </span><span class="nt">land_speed</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.2</span><span class="w"> </span><span class="c1"># m/s</span>
<span class="linenos">28</span><span class="w">         </span><span class="nt">land_detected_treshold</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.1</span><span class="w"> </span><span class="c1"># m/s</span>
<span class="linenos">29</span><span class="w">         </span><span class="nt">countdown_to_disarm</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3.0</span><span class="w"> </span><span class="c1"># s</span>
<span class="linenos">30</span><span class="w">      </span><span class="nt">CustomWaypointMode</span><span class="p">:</span>
<span class="linenos">31</span><span class="w">         </span><span class="nt">valid_transitions</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;HoldMode&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;LandMode&quot;</span><span class="p p-Indicator">]</span>
<span class="linenos">32</span><span class="w">         </span><span class="nt">fallback</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;HoldMode&quot;</span>
<span class="linenos">33</span><span class="w">         </span><span class="nt">waypoint_topic</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;waypoint&quot;</span>
<span class="linenos">34</span><span class="w">      </span><span class="c1"># Topics configurations for the autopilot to communicate with the rest of the system</span>
<span class="linenos">35</span><span class="w">      </span><span class="nt">publishers</span><span class="p">:</span>
<span class="linenos">36</span><span class="w">         </span><span class="nt">control_position</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;fmu/in/position&quot;</span>
<span class="linenos">37</span><span class="w">         </span><span class="nt">control_attitude</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;fmu/in/force/attitude&quot;</span>
<span class="linenos">38</span><span class="w">         </span><span class="nt">control_attitude_rate</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;fmu/in/force/attitude_rate&quot;</span>
<span class="linenos">39</span><span class="w">         </span><span class="nt">status</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;autopilot/status&quot;</span>
<span class="linenos">40</span><span class="w">      </span><span class="nt">subscribers</span><span class="p">:</span>
<span class="linenos">41</span><span class="w">         </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;fmu/filter/state&quot;</span>
<span class="linenos">42</span><span class="w">         </span><span class="nt">status</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;fmu/status&quot;</span>
<span class="linenos">43</span><span class="w">         </span><span class="nt">constants</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;fmu/constants&quot;</span>
<span class="linenos">44</span><span class="w">      </span><span class="nt">services</span><span class="p">:</span>
<span class="linenos">45</span><span class="w">         </span><span class="nt">set_mode</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;autopilot/change_mode&quot;</span>
<span class="linenos">46</span><span class="w">      </span><span class="c1"># ----------------------------------------------------------------------------------------------------------</span>
<span class="linenos">47</span><span class="w">      </span><span class="c1"># Definition of the controller that will perform the tracking of references of the different operation modes</span>
<span class="linenos">48</span><span class="w">      </span><span class="c1"># ----------------------------------------------------------------------------------------------------------</span>
<span class="linenos">49</span><span class="w">      </span><span class="nt">controller</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;OnboardController&quot;</span>
<span class="linenos">50</span><span class="w">      </span><span class="nt">OnboardController</span><span class="p">:</span>
<span class="linenos">51</span><span class="w">         </span><span class="nt">publishers</span><span class="p">:</span>
<span class="linenos">52</span><span class="w">            </span><span class="nt">control_position</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;fmu/in/position&quot;</span>
<span class="linenos">53</span><span class="w">            </span><span class="nt">control_attitude</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;fmu/in/force/attitude&quot;</span>
<span class="linenos">54</span><span class="w">            </span><span class="nt">control_attitude_rate</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;fmu/in/force/attitude_rate&quot;</span>
<span class="linenos">55</span><span class="w">      </span><span class="c1"># ----------------------------------------------------------------------------------------------------------</span>
<span class="linenos">56</span><span class="w">      </span><span class="c1"># Definition of the geofencing mechanism that will keep the vehicle in safe places</span>
<span class="linenos">57</span><span class="w">      </span><span class="c1"># ----------------------------------------------------------------------------------------------------------</span>
<span class="linenos">58</span><span class="w">      </span><span class="nt">geofencing</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;BoxGeofencing&quot;</span>
<span class="linenos">59</span><span class="w">      </span><span class="nt">BoxGeofencing</span><span class="p">:</span>
<span class="linenos">60</span><span class="w">         </span><span class="nt">limits_x</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">-10.0</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">10.0</span><span class="p p-Indicator">]</span>
<span class="linenos">61</span><span class="w">         </span><span class="nt">limits_y</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">-10.0</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">10.0</span><span class="p p-Indicator">]</span>
<span class="linenos">62</span><span class="w">         </span><span class="nt">limits_z</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">-10.0</span><span class="p p-Indicator">,</span><span class="w">  </span><span class="nv">1.0</span><span class="p p-Indicator">]</span><span class="w"> </span><span class="c1"># NED Coordinades (z-negative is up)</span>
<span class="linenos">63</span><span class="w">      </span><span class="c1"># ----------------------------------------------------------------------------------------------------------</span>
<span class="linenos">64</span><span class="w">      </span><span class="c1"># Definition of the trajectory manager that generates parameterized trajectories to be followed</span>
<span class="linenos">65</span><span class="w">      </span><span class="c1"># ----------------------------------------------------------------------------------------------------------</span>
<span class="linenos">66</span><span class="w">      </span><span class="nt">trajectory_manager</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;StaticTrajectoryManager&quot;</span>
<span class="linenos">67</span><span class="w">      </span><span class="nt">StaticTrajectoryManager</span><span class="p">:</span>
<span class="linenos">68</span><span class="w">         </span><span class="nt">services</span><span class="p">:</span>
<span class="linenos">69</span><span class="w">            </span><span class="nt">reset_trajectory</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;autopilot/trajectory/reset&quot;</span>
</pre></div>
</div>
<ol class="arabic simple" start="8">
<li><p>Create a launch file named <code class="docutils literal notranslate"><span class="pre">custom_modes.launch.py</span></code> inside the package directory. This file will launch the autopilot with the configurations provided in the <code class="docutils literal notranslate"><span class="pre">custom_modes.yaml</span></code> file.</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create a launch file inside the package directory</span>
touch<span class="w"> </span>launch/custom_modes.launch.py
</pre></div>
</div>
<p>The content of the <code class="docutils literal notranslate"><span class="pre">custom_modes.launch.py</span></code> file should be as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="kn">from</span> <span class="nn">launch</span> <span class="kn">import</span> <span class="n">LaunchDescription</span>
<span class="linenos"> 2</span><span class="kn">from</span> <span class="nn">launch_ros.actions</span> <span class="kn">import</span> <span class="n">Node</span>
<span class="linenos"> 3</span><span class="kn">from</span> <span class="nn">launch.actions</span> <span class="kn">import</span> <span class="n">DeclareLaunchArgument</span>
<span class="linenos"> 4</span><span class="kn">from</span> <span class="nn">launch.substitutions</span> <span class="kn">import</span> <span class="n">LaunchConfiguration</span>
<span class="linenos"> 5</span>
<span class="linenos"> 6</span><span class="k">def</span> <span class="nf">generate_launch_description</span><span class="p">():</span>
<span class="linenos"> 7</span>   <span class="k">return</span> <span class="n">LaunchDescription</span><span class="p">([</span>
<span class="linenos"> 8</span>      <span class="n">DeclareLaunchArgument</span><span class="p">(</span>
<span class="linenos"> 9</span>         <span class="s1">&#39;config_file&#39;</span><span class="p">,</span>
<span class="linenos">10</span>         <span class="n">default_value</span><span class="o">=</span><span class="s1">&#39;custom_modes.yaml&#39;</span><span class="p">,</span>
<span class="linenos">11</span>         <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Path to the configuration file for the autopilot&#39;</span>
<span class="linenos">12</span>      <span class="p">),</span>
<span class="linenos">13</span>      <span class="n">Node</span><span class="p">(</span>
<span class="linenos">14</span>         <span class="n">package</span><span class="o">=</span><span class="s1">&#39;autopilot&#39;</span><span class="p">,</span>
<span class="linenos">15</span>         <span class="n">executable</span><span class="o">=</span><span class="s1">&#39;autopilot_node&#39;</span><span class="p">,</span>
<span class="linenos">16</span>         <span class="n">name</span><span class="o">=</span><span class="s1">&#39;autopilot&#39;</span><span class="p">,</span>
<span class="linenos">17</span>         <span class="n">output</span><span class="o">=</span><span class="s1">&#39;screen&#39;</span><span class="p">,</span>
<span class="linenos">18</span>         <span class="n">parameters</span><span class="o">=</span><span class="p">[</span><span class="n">LaunchConfiguration</span><span class="p">(</span><span class="s1">&#39;config_file&#39;</span><span class="p">)]</span>
<span class="linenos">19</span>      <span class="p">)</span>
<span class="linenos">20</span>   <span class="p">])</span>
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="autopilot.html" class="btn btn-neutral float-left" title="Autopilot" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="controllers.html" class="btn btn-neutral float-right" title="Controllers" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Marcelo Jacinto.</p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>